<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Zmarty</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .callback-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .sub-message {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .error-message {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .success-message {
            color: #059669;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .retry-button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        
        .retry-button:hover {
            background: #5a67d8;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-toggle {
            background: none;
            border: none;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="spinner" id="spinner"></div>
        <div class="status-message" id="status-message">Processing authentication...</div>
        <div class="sub-message" id="sub-message">Please wait while we complete your sign-in</div>
        
        <div class="error-message" id="error-message" style="display: none;"></div>
        <div class="success-message" id="success-message" style="display: none;"></div>
        
        <a href="/" class="retry-button" id="retry-button" style="display: none;">Try Again</a>
        
        <button class="debug-toggle" onclick="toggleDebug()">Show Debug Info</button>
        <div class="debug-info" id="debug-info"></div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // OAuth Callback Handler - Simplified approach using Supabase automatic processing
        
        // Configuration
        const SUPABASE_URL = 'https://xhskmqsgtdhehzlvtuns.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhoc2ttcXNndGRoZWh6bHZ0dW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNDkzNTQsImV4cCI6MjA3MzcyNTM1NH0.ULAf9vNHS4nasSnv9UOKS2MCKsSxcMtV3C-R7Wm6qMw';
        
        // Debug logging
        const debugLog = [];
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry, data || '');
            debugLog.push(data ? `${logEntry} ${JSON.stringify(data)}` : logEntry);
            updateDebugInfo();
        }
        
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.textContent = debugLog.join('\n');
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // UI update functions
        function updateStatus(message, subMessage = '') {
            document.getElementById('status-message').textContent = message;
            document.getElementById('sub-message').textContent = subMessage;
        }
        
        function showError(message) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('retry-button').style.display = 'inline-block';
            updateStatus('Authentication Failed', 'There was a problem signing you in');
        }
        
        function showSuccess(message) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-message').style.display = 'block';
            updateStatus('Authentication Successful!', 'Redirecting to your dashboard...');
        }
        
        // Initialize Supabase client with proper PKCE configuration
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                detectSessionInUrl: true,  // Critical for OAuth callback handling
                flowType: 'pkce',          // Use PKCE flow
                autoRefreshToken: true,
                persistSession: true,
                debug: true
            }
        });
        
        log('Supabase client initialized with PKCE configuration');
        
        // Main callback handler
        async function handleOAuthCallback() {
            try {
                log('Starting OAuth callback handler');
                
                // Check URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const urlHash = window.location.hash;
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                const errorDescription = urlParams.get('error_description');
                
                log('URL analysis', {
                    hasCode: !!code,
                    hasError: !!error,
                    hasHash: !!urlHash,
                    search: window.location.search,
                    hash: urlHash
                });
                
                // Handle OAuth errors
                if (error) {
                    log('OAuth error detected', { error, errorDescription });
                    showError(`Authentication failed: ${errorDescription || error}`);
                    return;
                }
                
                // Wait for Supabase to automatically process the OAuth callback
                log('Waiting for Supabase to process OAuth callback...');
                updateStatus('Processing authentication...', 'Supabase is handling the OAuth flow');
                
                // Set up auth state change listener
                const authPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Authentication timeout - no session established within 15 seconds'));
                    }, 15000);
                    
                    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                        log('Auth state change', { event, hasSession: !!session, hasUser: !!session?.user });
                        
                        if (event === 'SIGNED_IN' && session?.user) {
                            clearTimeout(timeout);
                            subscription.unsubscribe();
                            resolve(session);
                        } else if (event === 'SIGNED_OUT') {
                            clearTimeout(timeout);
                            subscription.unsubscribe();
                            reject(new Error('User was signed out during authentication'));
                        }
                    });
                });
                
                // Also check for existing session
                const { data: { session: existingSession } } = await supabase.auth.getSession();
                if (existingSession?.user) {
                    log('Existing session found', { email: existingSession.user.email });
                    handleAuthSuccess(existingSession);
                    return;
                }
                
                // Wait for authentication to complete
                const session = await authPromise;
                handleAuthSuccess(session);
                
            } catch (error) {
                log('OAuth callback error', { error: error.message });
                console.error('OAuth callback error:', error);
                
                if (error.message.includes('timeout')) {
                    showError('Authentication timed out. Please try signing in again.');
                } else {
                    showError('Authentication failed. Please try again.');
                }
            }
        }
        
        function handleAuthSuccess(session) {
            log('Authentication successful', { 
                email: session.user.email,
                provider: session.user.app_metadata?.provider,
                userId: session.user.id
            });
            
            // Store user data
            const userData = {
                email: session.user.email,
                userId: session.user.id,
                authProvider: session.user.app_metadata?.provider || 'email',
                fullName: session.user.user_metadata?.full_name || 
                         session.user.user_metadata?.name || 
                         session.user.user_metadata?.display_name || '',
                isAuthenticated: true,
                timestamp: Date.now()
            };
            
            localStorage.setItem('zmarty_user_data', JSON.stringify(userData));
            log('User data stored', userData);
            
            showSuccess(`Welcome ${userData.fullName || userData.email}!`);
            
            // Redirect to main app after short delay
            setTimeout(() => {
                log('Redirecting to main application');
                window.location.href = '/';
            }, 2000);
        }
        
        // Start the callback handler when page loads
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM loaded, starting OAuth callback handler');
            handleOAuthCallback();
        });
        
        log('OAuth callback page initialized');
    </script>
</body>
</html>
