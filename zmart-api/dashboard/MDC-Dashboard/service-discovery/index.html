<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Discovery - ZmartBot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            padding: 30px 20px;
            border-bottom: 1px solid #333;
            text-align: center;
        }
        
        .header h1 {
            color: #4fd1c7;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(79, 209, 199, 0.3);
        }
        
        .header p {
            color: #a0a0a0;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .discovery-overview {
            background: linear-gradient(135deg, #1e2832 0%, #1a2332 100%);
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .overview-title {
            color: #4fd1c7;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: rgba(79, 209, 199, 0.05);
            border: 1px solid rgba(79, 209, 199, 0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(79, 209, 199, 0.2);
        }
        
        .metric-value {
            color: #4fd1c7;
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }
        
        .metric-label {
            color: #a0a0a0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2d3748;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(45, 55, 72, 0.3);
            border-radius: 6px;
        }
        
        .status-label {
            color: #a0a0a0;
            font-size: 0.9rem;
        }
        
        .status-value {
            color: #4fd1c7;
            font-weight: 600;
        }
        
        .connection-breakdown {
            background: #1a2332;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .breakdown-title {
            color: #4fd1c7;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }
        
        .connection-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .connection-type {
            background: rgba(45, 55, 72, 0.4);
            border-left: 4px solid;
            padding: 15px;
            border-radius: 6px;
        }
        
        .connection-type.active {
            border-left-color: #48bb78;
        }
        
        .connection-type.potential {
            border-left-color: #ed8936;
        }
        
        .connection-type.priority {
            border-left-color: #f56565;
        }
        
        .type-count {
            color: #fff;
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .type-label {
            color: #a0a0a0;
            font-size: 0.9rem;
        }
        
        .refresh-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4fd1c7, #38b2ac);
            color: #0f1419;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 209, 199, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: #fff;
        }
        
        .loading {
            text-align: center;
            color: #4fd1c7;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        
        .error {
            color: #f56565;
            text-align: center;
            padding: 20px;
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            border-radius: 8px;
            margin: 20px 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .updating {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Service Discovery</h1>
        <p>Complete overview of all services and their connections</p>
        <div style="background: #28a745; color: #fff; padding: 15px 25px; border-radius: 20px; display: inline-block; margin-top: 15px; font-weight: 600;">
            ‚úÖ SYSTEM OPERATIONAL - macOS LaunchServices Fixed!
        </div>
    </div>
    
    <div class="container">
        <div class="discovery-overview">
            <h2 class="overview-title">System Connection Analysis</h2>
            
            <div class="overview-grid">
                <div class="metric-card">
                    <span class="metric-value" id="servicesWithConnections">--</span>
                    <span class="metric-label">Services with Connections</span>
                </div>
                
                <div class="metric-card">
                    <span class="metric-value" id="totalConnections">--</span>
                    <span class="metric-label">Total Connections</span>
                </div>
                
                <div class="metric-card">
                    <span class="metric-value" id="activeServices">--</span>
                    <span class="metric-label">Active Services</span>
                </div>
                
                <div class="metric-card">
                    <span class="metric-value" id="registeredServices">--</span>
                    <span class="metric-label">Registered Services</span>
                </div>
            </div>
            
            <div class="status-info">
                <div class="status-item">
                    <span class="status-label">Last Updated</span>
                    <span class="status-value" id="lastUpdated">--</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Discovery Method</span>
                    <span class="status-value" id="discoveryMethod">--</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">MDC Files</span>
                    <span class="status-value" id="mdcFiles">--</span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">System Status</span>
                    <span class="status-value" id="systemStatus">--</span>
                </div>
            </div>
        </div>
        
        <div class="connection-breakdown">
            <h3 class="breakdown-title">Connection Type Breakdown</h3>
            
            <div class="connection-types">
                <div class="connection-type active">
                    <span class="type-count" id="activeConnections">--</span>
                    <span class="type-label">‚úÖ Active Connections</span>
                </div>
                
                <div class="connection-type potential">
                    <span class="type-count" id="potentialConnections">--</span>
                    <span class="type-label">‚è≥ Potential Connections</span>
                </div>
                
                <div class="connection-type priority">
                    <span class="type-count" id="priorityConnections">--</span>
                    <span class="type-label">üî• Priority Connections</span>
                </div>
            </div>
        </div>
        
        <!-- Clear Instructions Section -->
        <div class="instruction-section" style="background: linear-gradient(135deg, #2d4a5b 0%, #1e3a4b 100%); border: 1px solid #4fd1c7; border-radius: 12px; padding: 25px; margin-bottom: 30px; text-align: center;">
            <h3 style="color: #4fd1c7; margin-bottom: 15px; font-size: 1.4rem;">üìã How to Generate MDC Files</h3>
            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <ol style="text-align: left; color: #e0e0e0; line-height: 1.6; max-width: 600px; margin: 0 auto;">
                    <li style="margin-bottom: 10px;"><strong>Step 1:</strong> Click "üß† Run AI Analysis" button below</li>
                    <li style="margin-bottom: 10px;"><strong>Step 2:</strong> Wait for AI to analyze all service connections (2-3 seconds)</li>
                    <li style="margin-bottom: 10px;"><strong>Step 3:</strong> The "üìÑ Generate MDC File" button will appear</li>
                    <li style="margin-bottom: 10px;"><strong>Step 4:</strong> Click it to generate implementation-ready MDC files</li>
                </ol>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="runAIAnalysis()" style="background: #4fd1c7; color: #000; font-size: 1.1rem; padding: 12px 30px;">
                    üöÄ Start AI Analysis Now
                </button>
                <button class="btn" onclick="quickDemo()" style="background: #28a745; color: #fff; font-size: 1.1rem; padding: 12px 30px;">
                    ‚ö° Quick Demo
                </button>
            </div>
        </div>
        
        <div class="ai-analysis-section">
            <h3 class="breakdown-title">ü§ñ ChatGPT AI Analysis</h3>
            
            <div class="ai-controls" style="display: flex; gap: 15px; margin-bottom: 20px; justify-content: center;">
                <button class="btn" onclick="runAIAnalysis()">üß† Run AI Analysis</button>
                <button class="btn btn-secondary" onclick="showConnections()">üîó View Recommendations</button>
                <button class="btn btn-secondary" onclick="showImprovements()">‚ö° View Improvements</button>
            </div>
            
            <div id="aiAnalysisResult" style="display: none; background: rgba(45, 55, 72, 0.4); border-radius: 8px; padding: 20px; margin-top: 15px;">
                <!-- AI analysis results will be displayed here -->
                <div id="mdcGenerateSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <h4 style="color: #4fd1c7; margin-bottom: 15px;">üìÑ Implementation Ready</h4>
                    <p style="color: #a0a0a0; margin-bottom: 15px;">Generate a complete MDC file to begin implementation:</p>
                    <button id="generateMDCBtn" class="btn" style="background: #28a745; border-color: #28a745;">
                        üìÑ Generate MDC File
                    </button>
                    <div id="mdcGenerationResult" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Database Tracking Cards -->
        <div class="database-tracking-section" style="margin-top: 30px;">
            <h3 class="breakdown-title">üóÑÔ∏è Automated Analysis Database</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                <!-- Analyzed Pairs Card -->
                <div class="database-card" style="background: #1a2332; border: 1px solid #2d3748; border-radius: 12px; padding: 25px;">
                    <h4 style="color: #4fd1c7; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üî¨</span> Generated Pairs & Results
                    </h4>
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #a0a0a0;">Total Analyzed:</span>
                            <span style="color: #4fd1c7; font-weight: bold;" id="totalAnalyzedPairs">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #a0a0a0;">Average Score:</span>
                            <span style="color: #4fd1c7; font-weight: bold;" id="averageScore">--</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showAnalyzedPairs()" style="width: 100%;">
                        üìä View All Pairs & ChatGPT Results
                    </button>
                </div>

                <!-- Winners Card -->
                <div class="database-card" style="background: #1a2332; border: 1px solid #2d3748; border-radius: 12px; padding: 25px;">
                    <h4 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üèÜ</span> Winners Database
                    </h4>
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #a0a0a0;">Total Winners:</span>
                            <span style="color: #28a745; font-weight: bold;" id="totalWinnersCount">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #a0a0a0;">Highest Score:</span>
                            <span style="color: #28a745; font-weight: bold;" id="highestScore">--</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showWinners()" style="width: 100%; background: #28a745; border-color: #28a745;">
                        üèÜ View Winners & Choose Random
                    </button>
                </div>
            </div>

            <!-- Add Another Recommendation Button -->
            <div style="text-align: center; margin-bottom: 25px;">
                <button class="btn" onclick="addAnotherRecommendation()" style="background: #6366f1; border-color: #6366f1; font-size: 1.1rem; padding: 12px 30px;">
                    ‚ûï Add Another Recommendation (Top 3 from Database)
                </button>
            </div>
        </div>

        <div class="combinations-section" style="margin-top: 30px;">
            <h3 class="breakdown-title">üß¨ Service Combinations Database</h3>
            
            <div class="combinations-stats" style="background: rgba(45, 55, 72, 0.4); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCombinations">-</div>
                        <div class="stat-label">Total Combinations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recentAnalyses">-</div>
                        <div class="stat-label">Analyses (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalWinners">-</div>
                        <div class="stat-label">Hourly Winners</div>
                    </div>
                </div>
            </div>

            <div class="combinations-tables" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="background: rgba(45, 55, 72, 0.4); border-radius: 8px; padding: 20px;">
                    <h4 style="color: #4fd1c7; margin-bottom: 15px;">üèÜ Top Combinations</h4>
                    <div id="topCombinations" style="font-size: 0.9rem;">
                        <div style="color: #a0a0a0; text-align: center; padding: 20px;">Loading combinations...</div>
                    </div>
                </div>
                
                <div style="background: rgba(45, 55, 72, 0.4); border-radius: 8px; padding: 20px;">
                    <h4 style="color: #4fd1c7; margin-bottom: 15px;">üìä By Service Type</h4>
                    <div id="combinationsByType" style="font-size: 0.9rem;">
                        <div style="color: #a0a0a0; text-align: center; padding: 20px;">Loading types...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="refresh-controls">
            <button class="btn" onclick="refreshDiscovery()">üîÑ Refresh Discovery</button>
            <button class="btn btn-secondary" onclick="toggleAutoRefresh()">‚öôÔ∏è Auto Refresh: <span id="autoRefreshStatus">ON</span></button>
        </div>
    </div>
    
    <script>
        let autoRefresh = true;
        let refreshInterval;
        
        // Load combinations data
        async function loadCombinationsData() {
            try {
                const response = await fetch('/api/combinations-stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update statistics
                document.getElementById('totalCombinations').textContent = data.total_combinations || 0;
                document.getElementById('recentAnalyses').textContent = data.recent_analyses_24h || 0;
                document.getElementById('totalWinners').textContent = data.total_winners || 0;
                
                // Update top combinations
                const topCombinationsDiv = document.getElementById('topCombinations');
                if (data.top_combinations && data.top_combinations.length > 0) {
                    topCombinationsDiv.innerHTML = data.top_combinations.slice(0, 5).map(combo => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div>
                                <div style="color: #4fd1c7; font-weight: 500;">${combo.service1} ‚Üî ${combo.service2}</div>
                                <div style="color: #a0a0a0; font-size: 0.8rem;">${combo.type}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #4fd1c7; font-weight: 500;">${combo.compatibility}/10</div>
                                <div style="color: #a0a0a0; font-size: 0.8rem;">Used ${combo.used_count}x</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    topCombinationsDiv.innerHTML = '<div style="color: #a0a0a0; text-align: center; padding: 20px;">No combinations yet</div>';
                }
                
                // Update combinations by type
                const byTypeDiv = document.getElementById('combinationsByType');
                if (data.combinations_by_type && data.combinations_by_type.length > 0) {
                    byTypeDiv.innerHTML = data.combinations_by_type.map(type => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div>
                                <div style="color: #4fd1c7; font-weight: 500;">${type.type}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #4fd1c7; font-weight: 500;">${type.count} pairs</div>
                                <div style="color: #a0a0a0; font-size: 0.8rem;">Avg: ${type.avg_compatibility}/10</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    byTypeDiv.innerHTML = '<div style="color: #a0a0a0; text-align: center; padding: 20px;">No type data yet</div>';
                }
                
            } catch (error) {
                console.error('Error loading combinations data:', error);
                document.getElementById('totalCombinations').textContent = 'Error';
                document.getElementById('recentAnalyses').textContent = 'Error';
                document.getElementById('totalWinners').textContent = 'Error';
            }
        }

        // Global variables for MDC generation
        let currentAnalysisData = null;
        let completedGenerations = JSON.parse(localStorage.getItem('completedMDCGenerations') || '{}');

        // Helper functions for completion tracking
        function getGenerationKey(serviceA, serviceB) {
            // Create consistent key regardless of order
            const services = [serviceA, serviceB].sort();
            return `${services[0]}-${services[1]}`;
        }

        function isGenerationCompleted(serviceA, serviceB) {
            const key = getGenerationKey(serviceA, serviceB);
            return completedGenerations[key] ? true : false;
        }

        function markGenerationCompleted(serviceA, serviceB, fileName, filePath) {
            const key = getGenerationKey(serviceA, serviceB);
            completedGenerations[key] = {
                fileName: fileName,
                filePath: filePath,
                completedAt: new Date().toISOString(),
                services: { serviceA, serviceB }
            };
            localStorage.setItem('completedMDCGenerations', JSON.stringify(completedGenerations));
        }

        function getCompletedGeneration(serviceA, serviceB) {
            const key = getGenerationKey(serviceA, serviceB);
            return completedGenerations[key] || null;
        }

        // Generate MDC file for current analysis
        async function generateMDCFile() {
            if (!currentAnalysisData) {
                alert('No analysis data available for MDC generation');
                return;
            }

            try {
                const generateBtn = document.getElementById('generateMDCBtn');
                const resultDiv = document.getElementById('mdcGenerationResult');
                
                // Update button state
                generateBtn.disabled = true;
                generateBtn.innerHTML = '‚è≥ Generating MDC File...';
                
                // Prepare data for MDC generation
                const mdcData = {
                    service_a: currentAnalysisData.service_a || 'ServiceA',
                    service_b: currentAnalysisData.service_b || 'ServiceB',
                    ai_analysis: currentAnalysisData.analysis || currentAnalysisData.content || 'AI analysis not available',
                    compatibility_score: currentAnalysisData.compatibility_score || 8.5,
                    service_type_a: currentAnalysisData.service_type_a || 'api',
                    service_type_b: currentAnalysisData.service_type_b || 'database'
                };
                
                // Make API call to generate MDC file
                const response = await fetch('/api/generate-mdc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(mdcData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(40, 167, 69, 0.2); border: 1px solid #28a745; border-radius: 6px; padding: 15px; margin-top: 10px;">
                            <h5 style="color: #28a745; margin: 0 0 10px 0;">‚úÖ MDC File Generated Successfully!</h5>
                            <p style="color: #e0e0e0; margin: 5px 0;"><strong>Integration Name:</strong> ${result.integration_name}</p>
                            <p style="color: #e0e0e0; margin: 5px 0;"><strong>File Path:</strong> ${result.file_path}</p>
                            <p style="color: #e0e0e0; margin: 5px 0;"><strong>Generated:</strong> ${new Date(result.generated_at).toLocaleString()}</p>
                            <div style="margin-top: 15px;">
                                <button onclick="viewGeneratedFiles()" class="btn btn-secondary" style="margin-right: 10px;">
                                    üìÅ View All Generated Files
                                </button>
                                <button onclick="downloadMDCFile('${result.file_path}')" class="btn btn-secondary">
                                    ‚¨áÔ∏è Open File Location
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.message || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error generating MDC file:', error);
                const resultDiv = document.getElementById('mdcGenerationResult');
                resultDiv.innerHTML = `
                    <div style="background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; border-radius: 6px; padding: 15px; margin-top: 10px;">
                        <h5 style="color: #dc3545; margin: 0 0 10px 0;">‚ùå MDC Generation Failed</h5>
                        <p style="color: #e0e0e0; margin: 0;">${error.message}</p>
                    </div>
                `;
            } finally {
                // Reset button state
                const generateBtn = document.getElementById('generateMDCBtn');
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üìÑ Generate MDC File';
            }
        }

        // View all generated MDC files
        async function viewGeneratedFiles() {
            try {
                const response = await fetch('/api/generated-files');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    let filesHtml = '<h4 style="color: #4fd1c7; margin-bottom: 15px;">üìÅ Generated MDC Files</h4>';
                    
                    if (result.generated_files.length === 0) {
                        filesHtml += '<p style="color: #a0a0a0;">No generated files yet.</p>';
                    } else {
                        filesHtml += '<div style="max-height: 300px; overflow-y: auto;">';
                        result.generated_files.forEach(file => {
                            const createdDate = new Date(file.created_at).toLocaleString();
                            const fileSizeKB = (file.size_bytes / 1024).toFixed(1);
                            
                            filesHtml += `
                                <div style="background: rgba(45, 55, 72, 0.6); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                    <div style="color: #4fd1c7; font-weight: 500;">${file.filename}</div>
                                    <div style="color: #a0a0a0; font-size: 0.9rem;">
                                        Created: ${createdDate} | Size: ${fileSizeKB} KB
                                    </div>
                                    <div style="color: #a0a0a0; font-size: 0.8rem; margin-top: 5px;">
                                        ${file.file_path}
                                    </div>
                                </div>
                            `;
                        });
                        filesHtml += '</div>';
                    }
                    
                    // Display in a modal-like overlay
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                    `;
                    
                    overlay.innerHTML = `
                        <div style="background: #1e2832; border-radius: 12px; padding: 30px; max-width: 700px; max-height: 80vh; overflow-y: auto; border: 1px solid #2d3748;">
                            ${filesHtml}
                            <button onclick="this.closest('.overlay').remove()" class="btn" style="margin-top: 20px;">Close</button>
                        </div>
                    `;
                    
                    overlay.className = 'overlay';
                    document.body.appendChild(overlay);
                } else {
                    alert('Error loading generated files: ' + (result.message || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error loading generated files:', error);
                alert('Error loading generated files: ' + error.message);
            }
        }

        // Download/open MDC file
        function downloadMDCFile(filePath) {
            // For now, just show the file path - in production could implement file download
            alert(`MDC file location:\\n${filePath}\\n\\nYou can open this file in your code editor to begin implementation.`);
        }

        // Toggle prompt display and load MDC content
        async function togglePrompt(promptId) {
            console.log('üîÑ togglePrompt called with:', promptId);
            
            const promptDiv = document.getElementById(promptId);
            
            // Handle different ID patterns: "prompt-0", "rec-prompt-0", direct content div access
            let index;
            let contentDivId;
            
            if (promptId.startsWith('rec-prompt-')) {
                index = promptId.split('-')[2];
                contentDivId = `rec-mdc-content-${index}`;
            } else {
                index = promptId.split('-')[1];
                contentDivId = `mdc-content-${index}`;
            }
            
            const mdcContentDiv = document.getElementById(contentDivId);
            
            console.log('üìã Elements found:', {
                promptDiv: !!promptDiv,
                mdcContentDiv: !!mdcContentDiv,
                index: index,
                contentDivId: contentDivId
            });
            
            if (!promptDiv) {
                console.error('‚ùå Prompt div not found:', promptId);
                alert(`Element not found: ${promptId}. Check browser console for details.`);
                return;
            }
            
            if (promptDiv.style.display === 'none' || !promptDiv.style.display) {
                console.log('üìñ Expanding prompt...');
                promptDiv.style.display = 'block';
                
                // Load the actual MDC content when expanding
                if (mdcContentDiv && mdcContentDiv.textContent.includes('Loading')) {
                    console.log('üîÑ Loading MDC content...');
                    await loadMDCContent(index, mdcContentDiv);
                } else {
                    console.log('‚ö†Ô∏è MDC content already loaded or div not found');
                    if (!mdcContentDiv) {
                        console.error('‚ùå MDC content div not found:', contentDivId);
                    }
                }
            } else {
                console.log('üìñ Collapsing prompt...');
                promptDiv.style.display = 'none';
            }
        }

        // Load and merge MDC files for display
        async function loadMDCContent(index, contentDiv) {
            try {
                contentDiv.innerHTML = '<div style="color: #4fd1c7;">üîÑ Loading and merging MDC files...</div>';
                
                // Get the service pair from the current analysis
                const serviceMapping = {
                    0: { serviceA: 'zmart-api', serviceB: 'kingfisher-module' },
                    1: { serviceA: 'my-symbols-extended-service', serviceB: 'zmart-analytics' },
                    2: { serviceA: 'doctor-service', serviceB: 'system-protection-service' }
                };
                
                const services = serviceMapping[index] || { serviceA: 'zmart-api', serviceB: 'kingfisher-module' };
                
                // Fetch the MDC content for both services
                const response = await fetch('/api/load-mdc-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_a: services.serviceA,
                        service_b: services.serviceB
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const mdcData = await response.json();
                
                if (mdcData.status === 'success') {
                    // Create comprehensive merged MDC content
                    const mergedContent = generateMergedMDCContent(services.serviceA, services.serviceB, mdcData);
                    contentDiv.innerHTML = `<div style="color: #e0e0e0;">${mergedContent}</div>`;
                } else {
                    throw new Error(mdcData.message || 'Failed to load MDC files');
                }
                
            } catch (error) {
                console.error('Error loading MDC content:', error);
                contentDiv.innerHTML = `<div style="color: #f56565;">‚ùå Error loading MDC content: ${error.message}</div>`;
            }
        }

        // Generate merged MDC content from both services
        function generateMergedMDCContent(serviceA, serviceB, mdcData) {
            const integrationName = `integration-${serviceA}-${serviceB}`;
            
            return `# ${integrationName}.mdc
> Type: integration | Version: 1.0.0 | Owner: zmartbot | Components: ${serviceA} + ${serviceB}

## Purpose
Enhanced integration between ${serviceA} and ${serviceB} for improved trading signal processing and API coordination.

## Overview
This integration combines the capabilities of ${serviceA} and ${serviceB} to create a seamless trading infrastructure with advanced signal processing and real-time market data coordination.

## Critical Functions
- **Signal Integration**: Real-time signal processing between services
- **API Coordination**: Unified API endpoints for trading operations  
- **Data Synchronization**: Synchronized market data and trading signals
- **Error Handling**: Comprehensive error handling across services

## Source MDC Files Combined:
${mdcData.service_a_content ? '‚úÖ' : '‚ùå'} ${serviceA}.mdc (${mdcData.service_a_content ? mdcData.service_a_content.split('\n').length : 0} lines)
${mdcData.service_b_content ? '‚úÖ' : '‚ùå'} ${serviceB}.mdc (${mdcData.service_b_content ? mdcData.service_b_content.split('\n').length : 0} lines)

## Architecture & Integration
- **Service Type:** integration
- **Dependencies:** ${serviceA}, ${serviceB}
- **Integration Points:** API, WebSocket, Database
- **Communication:** REST API + Real-time WebSocket

## API Integration Points
### From ${serviceA}:
${extractAPIEndpoints(mdcData.service_a_content)}

### From ${serviceB}:
${extractAPIEndpoints(mdcData.service_b_content)}

### New Integration Endpoints:
- GET /api/v1/integration/${integrationName}/status
- POST /api/v1/integration/${integrationName}/sync
- WS /ws/integration/${integrationName}/signals

## Implementation Plan
1. **Phase 1**: API endpoint mapping and integration
2. **Phase 2**: Real-time signal synchronization
3. **Phase 3**: Error handling and monitoring
4. **Phase 4**: Performance optimization

## Health & Readiness
- Liveness: /integration/${integrationName}/health
- Readiness: /integration/${integrationName}/ready
- Dependencies: Both source services must be healthy

## Generated Details:
- Created: ${new Date().toISOString()}
- MDCAgent: Ready for comprehensive enhancement
- ChatGPT Integration: Enabled for intelligent analysis`;
        }

        // Extract API endpoints from MDC content
        function extractAPIEndpoints(mdcContent) {
            if (!mdcContent) return '- No API endpoints found';
            
            const lines = mdcContent.split('\n');
            const endpoints = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('- GET ') || line.startsWith('- POST ') || line.startsWith('- PUT ') || line.startsWith('- DELETE ')) {
                    endpoints.push(line);
                }
            }
            
            return endpoints.length > 0 ? endpoints.join('\n') : '- API endpoints to be documented';
        }

        // Generate comprehensive MDC file using MDCAgent + ChatGPT
        async function generateComprehensiveMDC(serviceA, serviceB, benefit, index) {
            try {
                // Check if this generation is already completed
                if (isGenerationCompleted(serviceA, serviceB)) {
                    const completed = getCompletedGeneration(serviceA, serviceB);
                    console.log('‚ö†Ô∏è Generation already completed:', completed);
                    
                    // Show already completed message
                    alert(`‚úÖ Integration already generated!\n\nFile: ${completed.fileName}\nCompleted: ${new Date(completed.completedAt).toLocaleString()}\n\nCheck your .cursor/rules/integration/ folder.`);
                    return;
                }

                const button = document.getElementById(`generate-btn-${index}`) || event.target;
                const statusDiv = document.getElementById(`generation-status-${index}`);
                const originalText = button.innerHTML;
                
                // Show pending status
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '‚è≥ Pending: Calling MDCAgent to generate integration file...';
                    statusDiv.style.background = 'rgba(255, 193, 7, 0.2)';
                    statusDiv.style.border = '1px solid #ffc107';
                    statusDiv.style.color = '#ffc107';
                }
                
                // Update button state
                button.innerHTML = 'ü§ñ Calling MDCAgent...';
                button.disabled = true;
                button.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
                
                console.log('üöÄ Generating comprehensive MDC file:', {
                    serviceA, serviceB, benefit, index
                });

                // Get the merged content from the preview - try different content div patterns
                let contentDiv = document.getElementById(`landscape-mdc-content-${index}`);
                if (!contentDiv) {
                    contentDiv = document.getElementById(`mdc-content-${index}`);
                }
                if (!contentDiv) {
                    contentDiv = document.getElementById(`rec-mdc-content-${index}`);
                }
                
                const mergedContent = contentDiv ? contentDiv.textContent : 'No content available';

                // Call MDCAgent with comprehensive data
                const response = await fetch('/api/mdc-agent-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_a: serviceA,
                        service_b: serviceB,
                        benefit: benefit,
                        merged_content: mergedContent,
                        integration_type: 'enhanced_trading_signal',
                        chatgpt_analysis: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    console.log('‚úÖ MDC Generation Success:', result);
                    
                    // Mark this generation as completed
                    markGenerationCompleted(serviceA, serviceB, result.integration_name + '.mdc', result.file_path);
                    
                    // Show finished status
                    if (statusDiv) {
                        console.log('üìä Updating status div to show finished state');
                        statusDiv.innerHTML = `‚úÖ Completed: Integration file created successfully! <br><small style="opacity: 0.8;">File: ${result.integration_name}.mdc</small>`;
                        statusDiv.style.background = 'rgba(40, 167, 69, 0.2)';
                        statusDiv.style.border = '1px solid #28a745';
                        statusDiv.style.color = '#28a745';
                        statusDiv.style.display = 'block'; // Ensure it's visible
                    } else {
                        console.warn('‚ö†Ô∏è Status div not found for index:', index);
                    }
                    
                    // Update button to show completion and prevent regeneration
                    if (button) {
                        button.innerHTML = '‚úÖ Completed - Already Generated';
                        button.style.background = '#6c757d';
                        button.disabled = true;
                        button.style.cursor = 'not-allowed';
                        button.onclick = function() {
                            alert(`‚úÖ Integration already generated!\n\nFile: ${result.integration_name}.mdc\nLocation: ${result.file_path}`);
                        };
                    }
                    
                    // Wait 2 seconds to let user see the finished status before showing popup
                    setTimeout(() => {
                        // Show success with file location
                        const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.9);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                    `;
                    
                    overlay.innerHTML = `
                        <div style="background: #1e2832; border-radius: 12px; padding: 40px; max-width: 700px; border: 2px solid #28a745; text-align: center;">
                            <h2 style="color: #28a745; margin: 0 0 20px 0;">üöÄ Integration MDC File Created!</h2>
                            
                            <div style="background: rgba(40, 167, 69, 0.1); padding: 25px; border-radius: 8px; margin: 20px 0; text-align: left;">
                                <h4 style="color: #28a745; margin: 0 0 15px 0;">‚úÖ ${serviceA} ‚Üî ${serviceB} Integration Ready</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                                    <div>
                                        <p style="color: #a0a0a0; margin: 0; font-size: 0.9rem;">Integration Name:</p>
                                        <p style="color: #4fd1c7; margin: 5px 0; font-weight: 600;">${result.integration_name}</p>
                                    </div>
                                    <div>
                                        <p style="color: #a0a0a0; margin: 0; font-size: 0.9rem;">File Size:</p>
                                        <p style="color: #4fd1c7; margin: 5px 0; font-weight: 600;">${result.file_size} KB</p>
                                    </div>
                                </div>
                                <p style="color: #a0a0a0; margin: 10px 0 5px 0; font-size: 0.9rem;">Enhancement Level:</p>
                                <span style="background: ${result.chatgpt_enhanced ? '#28a745' : '#6c757d'}; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                    ${result.chatgpt_enhanced ? 'ü§ñ ChatGPT-4 Enhanced' : '‚ö° Basic Template'}
                                </span>
                            </div>
                            
                            <div style="background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; font-family: monospace; color: #0f0; font-size: 0.9rem; text-align: left; border: 1px solid #333;">
                                <div style="color: #4fd1c7; margin-bottom: 10px; font-weight: bold;">üìÅ File Location:</div>
                                <div style="word-break: break-all;">${result.file_path}</div>
                            </div>
                            
                            <p style="color: #a0a0a0; margin: 15px 0; line-height: 1.5;">
                                Your integration MDC file is ready! The file starts with <strong style="color: #4fd1c7;">"integration-"</strong> for easy sorting.<br>
                                <strong style="color: #28a745;">Next step:</strong> Open the file and begin implementing the integration.
                            </p>
                            
                            <div style="margin-top: 25px;">
                                <button onclick="closeSuccessPopup(this)" 
                                        style="background: #28a745; color: #fff; border: none; padding: 15px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-right: 15px;">
                                    üéØ Perfect! Let's implement
                                </button>
                                <button onclick="openFileLocation('${result.file_path}')" 
                                        style="background: #4fd1c7; color: #000; border: none; padding: 15px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.1rem;">
                                    üìÅ Open File Location
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    }, 2000); // Show popup after 2 seconds

                } else {
                    throw new Error(result.message || 'MDCAgent generation failed');
                }

            } catch (error) {
                console.error('Error calling MDCAgent:', error);
                
                // Show error status
                if (statusDiv) {
                    statusDiv.innerHTML = `‚ùå Failed: Error generating integration file<br><small style="opacity: 0.8;">Error: ${error.message}</small>`;
                    statusDiv.style.background = 'rgba(220, 53, 69, 0.2)';
                    statusDiv.style.border = '1px solid #dc3545';
                    statusDiv.style.color = '#dc3545';
                }
                
                // Update button to show error
                if (button) {
                    button.innerHTML = '‚ùå Generation Failed - Click to Retry';
                    button.style.background = '#dc3545';
                    button.disabled = false;
                }
                
                // Show error overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                
                overlay.innerHTML = `
                    <div style="background: #1e2832; border-radius: 12px; padding: 40px; max-width: 500px; border: 2px solid #dc3545; text-align: center;">
                        <h3 style="color: #dc3545; margin: 0 0 20px 0;">‚ùå MDCAgent Error</h3>
                        <p style="color: #e0e0e0; margin: 15px 0;">${error.message}</p>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="background: #dc3545; color: #fff; border: none; padding: 15px 30px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(overlay);

            } finally {
                // Reset button (only if generation failed - success case keeps button disabled)
                if (button && !button.innerHTML.includes('Successfully')) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                }
            }
        }

        // Open file location (system-dependent)
        function openFileLocation(filePath) {
            alert(`MDC file saved at:\\n${filePath}\\n\\nUse your editor to open this file and begin implementation.`);
        }

        // Close success popup
        function closeSuccessPopup(buttonElement) {
            console.log('üîÑ Closing success popup');
            const overlay = buttonElement.closest('div[style*="position: fixed"]');
            if (overlay) {
                overlay.remove();
                console.log('‚úÖ Success popup closed');
                
                // Hide all status indicators after 3 seconds
                setTimeout(() => {
                    const statusDivs = document.querySelectorAll('[id^="generation-status-"]');
                    statusDivs.forEach(div => {
                        if (div.innerHTML.includes('‚úÖ Finished')) {
                            div.style.display = 'none';
                        }
                    });
                }, 3000);
            } else {
                console.error('‚ùå Could not find overlay to close');
            }
        }

        // Show connections view and automatically select a specific card
        async function showConnectionsAndSelect(cardIndex) {
            console.log('üîÑ Redirecting to recommendations view and selecting card:', cardIndex);
            
            // First show the connections view
            try {
                const response = await fetch('/api/discovery/recommendations');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayConnectionRecommendations(data.connection_recommendations);
                
                // Wait a moment for the view to render, then automatically select the card
                setTimeout(() => {
                    showRecommendationPreview(cardIndex);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Failed to load connection recommendations:', error);
                showError(`Failed to load recommendations: ${error.message}`);
            }
        }

        // Show recommendation preview in landscape card
        async function showRecommendationPreview(index) {
            console.log('üîÑ showRecommendationPreview called with index:', index);
            
            const recommendation = window.currentRecommendations[index];
            if (!recommendation) {
                console.error('‚ùå Recommendation not found at index:', index);
                return;
            }
            
            const previewDiv = document.getElementById('recommendation-preview');
            const previewContent = document.getElementById('preview-content');
            
            if (!previewDiv || !previewContent) {
                console.error('‚ùå Preview elements not found');
                return;
            }
            
            // Show the preview card
            previewDiv.style.display = 'block';
            
            // Build the preview content
            previewContent.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: start;">
                    <!-- Left Side - Integration Details -->
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 25px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #4fd1c7; margin: 0 0 10px 0; font-size: 1.4rem;">
                                ${recommendation.service_a} ‚Üî ${recommendation.service_b}
                            </h3>
                            <span style="background: ${recommendation.priority === 'high' ? '#48bb78' : recommendation.priority === 'medium' ? '#ed8936' : '#718096'}; 
                                         color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; text-transform: uppercase;">
                                ${recommendation.priority} Priority Integration
                            </span>
                        </div>
                        
                        <div style="space-y: 15px;">
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #4fd1c7; margin: 0 0 8px 0; font-size: 1rem;">üéØ Integration Type</h4>
                                <p style="color: #e0e0e0; margin: 0; background: rgba(79, 209, 199, 0.1); padding: 10px; border-radius: 6px;">
                                    ${recommendation.connection_type.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())}
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #4fd1c7; margin: 0 0 8px 0; font-size: 1rem;">üí° Business Benefit</h4>
                                <p style="color: #e0e0e0; margin: 0; line-height: 1.5;">
                                    ${recommendation.benefit}
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #4fd1c7; margin: 0 0 8px 0; font-size: 1rem;">‚ö° Implementation Effort</h4>
                                <span style="background: ${recommendation.implementation_effort === 'low' ? '#48bb78' : recommendation.implementation_effort === 'medium' ? '#ed8936' : '#f56565'}; 
                                             color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; text-transform: capitalize;">
                                    ${recommendation.implementation_effort} Effort Required
                                </span>
                            </div>
                        </div>
                        
                        <!-- Generate Button and Status -->
                        <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(79, 209, 199, 0.3);">
                            <!-- Status Indicator -->
                            <div id="generation-status-\${index}" style="display: none; margin-bottom: 15px; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 1rem;">
                                <!-- Status content will be updated dynamically -->
                            </div>
                            
                            <!-- Completion Check and Button Display -->
                            \${(() => {
                                const isCompleted = isGenerationCompleted(recommendation.service_a, recommendation.service_b);
                                const completedData = isCompleted ? getCompletedGeneration(recommendation.service_a, recommendation.service_b) : null;
                                
                                if (isCompleted) {
                                    // Show completed state with file name
                                    return \`
                                        <div style="text-align: center; margin-bottom: 15px; padding: 15px; background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; border-radius: 8px;">
                                            <div style="color: #28a745; font-weight: 600; font-size: 1rem; margin-bottom: 8px;">
                                                ‚úÖ Integration Already Generated
                                            </div>
                                            <div style="color: #4fd1c7; font-family: monospace; font-size: 0.9rem; word-break: break-all;">
                                                üìÅ \${completedData.fileName}
                                            </div>
                                            <div style="color: #a0a0a0; font-size: 0.8rem; margin-top: 5px;">
                                                Generated: \${new Date(completedData.completedAt).toLocaleString()}
                                            </div>
                                        </div>
                                        <button onclick="alert('‚úÖ Integration already exists!\\\\nFile: \${completedData.fileName}\\\\nLocation: \${completedData.filePath}')" 
                                                style="background: #6c757d; color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; opacity: 0.8;">
                                            üìÇ View Generated File
                                        </button>
                                    \`;
                                } else {
                                    // Show generation button
                                    return \`
                                        <button id="generate-btn-\${index}" onclick="generateComprehensiveMDC('\${recommendation.service_a}', '\${recommendation.service_b}', '\${recommendation.benefit}', \${index})" 
                                                style="background: linear-gradient(135deg, #28a745, #20c997); color: #fff; border: none; 
                                                       padding: 15px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 600; 
                                                       cursor: pointer; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;"
                                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'"
                                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                                            üöÄ Generate MDC Integration File
                                        </button>
                                    \`;
                                }
                            })()}
                        </div>
                    </div>
                    
                    <!-- Right Side - MDC File Preview -->
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 25px;">
                        <h4 style="color: #4fd1c7; margin: 0 0 15px 0; font-size: 1.2rem;">üìÑ Integration MDC Preview</h4>
                        
                        <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; 
                                    font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 0.8rem; 
                                    color: #e0e0e0; max-height: 400px; overflow-y: auto;">
                            <div id="landscape-mdc-content-${index}" style="white-space: pre-wrap; line-height: 1.4;">
Loading complete integration MDC file for ${recommendation.service_a} ‚Üî ${recommendation.service_b}...
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(79, 209, 199, 0.1); border-radius: 6px; border-left: 3px solid #4fd1c7;">
                            <p style="color: #4fd1c7; margin: 0; font-size: 0.9rem; font-weight: 600;">
                                üí° This complete MDC file combines both service configurations with intelligent integration analysis
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Load the MDC content
            const mdcContentDiv = document.getElementById(`landscape-mdc-content-${index}`);
            if (mdcContentDiv) {
                console.log('üîÑ Loading MDC content for landscape view...');
                await loadMDCContent(index, mdcContentDiv);
            }
            
            // Scroll to preview
            previewDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Generate integration MDC file for specific service pair
        async function generateIntegrationMDC(serviceA, serviceB, benefit, priority) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚è≥ Copying prompt...';
                button.disabled = true;
                
                // Create the comprehensive ChatGPT prompt
                const chatGPTPrompt = `Please create a comprehensive MDC file for integrating ${serviceA} with ${serviceB}.

**Integration Requirements:**
- Service A: ${serviceA}
- Service B: ${serviceB} 
- Priority: ${priority}
- Benefit: ${benefit}

**Please include in the MDC file:**

1. **Integration Overview**
   - Purpose and objectives of connecting these services
   - Expected business value and technical benefits

2. **Architecture Design**
   - API endpoints and data flow between services
   - Security considerations and authentication
   - Error handling and retry mechanisms

3. **Implementation Steps**
   - Step-by-step integration process
   - Required configuration changes
   - Code examples for key connection points

4. **Testing Strategy** 
   - Unit tests for integration points
   - End-to-end testing scenarios
   - Performance benchmarks

5. **Deployment Guidelines**
   - Deployment sequence and dependencies
   - Rollback procedures
   - Monitoring and alerting setup

6. **Documentation**
   - API documentation updates
   - Operational runbooks
   - Troubleshooting guides

Please format the response as a complete MDC file ready for implementation.`;

                // Copy prompt to clipboard
                try {
                    await navigator.clipboard.writeText(chatGPTPrompt);
                    
                    // Show success message
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                    `;
                    
                    overlay.innerHTML = `
                        <div style="background: #1e2832; border-radius: 12px; padding: 40px; max-width: 500px; border: 2px solid #4fd1c7; text-align: center;">
                            <h3 style="color: #4fd1c7; margin: 0 0 20px 0;">‚úÖ ChatGPT Prompt Copied!</h3>
                            
                            <div style="background: rgba(79, 209, 199, 0.1); padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h4 style="color: #28a745; margin: 0 0 15px 0;">Integration: ${serviceA} ‚Üî ${serviceB}</h4>
                                <p style="color: #e0e0e0; margin: 5px 0;">Priority: ${priority}</p>
                                <p style="color: #e0e0e0; margin: 5px 0;">Benefit: ${benefit}</p>
                            </div>
                            
                            <div style="background: #000; padding: 15px; border-radius: 6px; margin: 20px 0; font-family: monospace; color: #0f0; font-size: 0.9rem;">
                                üìã Prompt is now in your clipboard
                            </div>
                            
                            <p style="color: #a0a0a0; margin: 15px 0; line-height: 1.5;">
                                Now go to <strong style="color: #4fd1c7;">ChatGPT</strong> and paste (Cmd+V) the prompt.<br>
                                ChatGPT will generate the complete MDC integration file for you.
                            </p>
                            
                            <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                    style="background: #4fd1c7; color: #000; border: none; padding: 15px 30px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1.1rem;">
                                Got it! Going to ChatGPT now
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    
                } catch (clipboardError) {
                    // Fallback if clipboard fails
                    alert(`Prompt ready! Copy this text to ChatGPT:\\n\\n${chatGPTPrompt}`);
                }
                
            } catch (error) {
                console.error('Error generating integration MDC:', error);
                alert(`‚ùå Error generating MDC file: ${error.message}`);
            } finally {
                // Reset button state
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Modified AI analysis functions to support MDC generation
        async function runAIAnalysis() {
            try {
                document.getElementById('aiAnalysisResult').style.display = 'block';
                document.getElementById('aiAnalysisResult').innerHTML = '<div style="text-align: center; padding: 20px;"><div style="color: #4fd1c7;">ü§ñ Running AI Analysis...</div></div>';
                
                const response = await fetch('/api/discovery/ai-analysis');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const analysis = await response.json();
                
                // Store analysis data for MDC generation
                currentAnalysisData = {
                    analysis: JSON.stringify(analysis),
                    service_a: 'DiscoveredServiceA',
                    service_b: 'DiscoveredServiceB',
                    compatibility_score: 8.5,
                    service_type_a: 'api',
                    service_type_b: 'database'
                };
                
                let resultHtml = '<div style="color: #4fd1c7; font-size: 1.1rem; margin-bottom: 15px;">üß† AI Analysis Results</div>';
                
                if (analysis.connection_recommendations && analysis.connection_recommendations.length > 0) {
                    resultHtml += '<h4 style="color: #4fd1c7; margin-top: 20px;">üîó Connection Recommendations:</h4>';
                    analysis.connection_recommendations.forEach(rec => {
                        resultHtml += `<div style="background: rgba(45, 55, 72, 0.6); padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 3px solid #4fd1c7;">${rec}</div>`;
                    });
                }
                
                if (analysis.service_improvements && analysis.service_improvements.length > 0) {
                    resultHtml += '<h4 style="color: #4fd1c7; margin-top: 20px;">‚ö° Service Improvements:</h4>';
                    analysis.service_improvements.forEach(imp => {
                        resultHtml += `<div style="background: rgba(45, 55, 72, 0.6); padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 3px solid #ffd700;">${imp}</div>`;
                    });
                }
                
                document.getElementById('aiAnalysisResult').innerHTML = resultHtml;
                document.getElementById('mdcGenerateSection').style.display = 'block';
                
            } catch (error) {
                console.error('AI analysis error:', error);
                document.getElementById('aiAnalysisResult').innerHTML = `<div style="color: #dc3545; text-align: center;">‚ùå AI Analysis Error: ${error.message}</div>`;
            }
        }

        // Update completion status for all recommendation cards
        function updateCompletionStatus() {
            try {
                const cards = document.querySelectorAll('[id^="generate-btn-"]');
                cards.forEach((button, index) => {
                    // Extract service names from button onclick attribute
                    const onclick = button.getAttribute('onclick');
                    if (onclick) {
                        const matches = onclick.match(/generateComprehensiveMDC\('([^']+)',\s*'([^']+)'/);
                        if (matches && matches.length >= 3) {
                            const serviceA = matches[1];
                            const serviceB = matches[2];
                            
                            if (isGenerationCompleted(serviceA, serviceB)) {
                                const completed = getCompletedGeneration(serviceA, serviceB);
                                const statusDiv = document.getElementById(`generation-status-${index}`);
                                
                                // Update status div to show completed state
                                if (statusDiv) {
                                    statusDiv.innerHTML = `‚úÖ Completed: Integration already exists<br><small style="opacity: 0.8; font-family: monospace;">üìÅ ${completed.fileName}</small>`;
                                    statusDiv.style.background = 'rgba(40, 167, 69, 0.2)';
                                    statusDiv.style.border = '1px solid #28a745';
                                    statusDiv.style.color = '#28a745';
                                    statusDiv.style.display = 'block';
                                }
                                
                                // Update button to show completed state
                                button.innerHTML = 'üìÇ View Generated File';
                                button.style.background = '#6c757d';
                                button.style.cursor = 'pointer';
                                button.style.opacity = '0.9';
                                button.onclick = function() {
                                    alert(`‚úÖ Integration Already Generated!\n\nFile: ${completed.fileName}\nGenerated: ${new Date(completed.completedAt).toLocaleString()}\n\nLocation:\n${completed.filePath}`);
                                };
                            }
                        }
                    }
                });
            } catch (error) {
                console.log('Error updating completion status:', error);
            }
        }

        // Load discovery data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDiscoveryData();
            loadCombinationsData();
            startAutoRefresh();
            
            // Update completion status after content loads
            setTimeout(updateCompletionStatus, 2000);
            
            // Bind MDC generation button
            document.getElementById('generateMDCBtn').addEventListener('click', generateMDCFile);
        });
        
        async function loadDiscoveryData() {
            try {
                // Add updating animation
                document.querySelector('.discovery-overview').classList.add('updating');
                
                const response = await fetch('/api/discovery/overview');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update main metrics
                document.getElementById('servicesWithConnections').textContent = data.services_with_connections || '--';
                document.getElementById('totalConnections').textContent = data.total_connections || '--';
                document.getElementById('activeServices').textContent = data.total_services || '--';
                document.getElementById('registeredServices').textContent = data.registered_services || '--';
                
                // Update connection breakdown
                document.getElementById('activeConnections').textContent = data.active_connections || '--';
                document.getElementById('potentialConnections').textContent = data.potential_connections || '--';
                document.getElementById('priorityConnections').textContent = data.priority_connections || '--';
                
                // Update status info
                document.getElementById('lastUpdated').textContent = data.last_updated || '--';
                document.getElementById('discoveryMethod').textContent = data.discovery_method || '--';
                document.getElementById('mdcFiles').textContent = data.mdc_files || '--';
                document.getElementById('systemStatus').textContent = data.status || '--';
                
                console.log('üîç Service Discovery loaded:', data);
                
            } catch (error) {
                console.error('‚ùå Failed to load discovery data:', error);
                showError(`Failed to load discovery data: ${error.message}`);
            } finally {
                // Remove updating animation
                document.querySelector('.discovery-overview').classList.remove('updating');
            }
        }
        
        function refreshDiscovery() {
            console.log('üîÑ Refreshing Service Discovery...');
            loadDiscoveryData();
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const statusEl = document.getElementById('autoRefreshStatus');
            statusEl.textContent = autoRefresh ? 'ON' : 'OFF';
            
            if (autoRefresh) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) return;
            
            refreshInterval = setInterval(() => {
                if (autoRefresh) {
                    loadDiscoveryData();
                }
            }, 30000); // 30 seconds
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // Remove existing errors
            const existingErrors = container.querySelectorAll('.error');
            existingErrors.forEach(el => el.remove());
            
            container.insertBefore(errorDiv, container.firstChild);
            
            // Auto-remove error after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // AI Analysis Functions
        async function runAIAnalysis() {
            const analysisButton = document.querySelector('[onclick="runAIAnalysis()"]');
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            try {
                analysisButton.textContent = 'üß† Analyzing...';
                analysisButton.disabled = true;
                
                resultDiv.innerHTML = '<div style="text-align: center; color: #4fd1c7;">ü§ñ ChatGPT is analyzing your MDC files for intelligent recommendations...</div>';
                resultDiv.style.display = 'block';
                
                const response = await fetch('/api/discovery/ai-analysis');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const analysis = await response.json();
                displayAIAnalysis(analysis);
                
                console.log('ü§ñ AI Analysis complete:', analysis);
                
            } catch (error) {
                console.error('‚ùå AI Analysis failed:', error);
                resultDiv.innerHTML = `<div class="error">AI Analysis failed: ${error.message}</div>`;
            } finally {
                analysisButton.textContent = 'üß† Run AI Analysis';
                analysisButton.disabled = false;
            }
        }
        
        // Quick Demo Function - Shows MDC generation instantly
        async function quickDemo() {
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            // Show demo analysis result
            const demoAnalysis = {
                connection_recommendations: [
                    {
                        service_a: "zmart-api",
                        service_b: "kingfisher-module", 
                        priority: "high",
                        benefit: "Enhanced trading signal integration with main API",
                        implementation_effort: "medium",
                        connection_type: "api_integration"
                    },
                    {
                        service_a: "my-symbols-extended-service",
                        service_b: "zmart-analytics", 
                        priority: "medium",
                        benefit: "Advanced analytics integration for symbol management",
                        implementation_effort: "low",
                        connection_type: "data_integration"
                    },
                    {
                        service_a: "doctor-service",
                        service_b: "system-protection-service", 
                        priority: "high",
                        benefit: "Comprehensive system health monitoring and protection",
                        implementation_effort: "medium",
                        connection_type: "monitoring_integration"
                    }
                ],
                service_improvements: [
                    {
                        service: "zmart-api",
                        improvement: "Implement real-time WebSocket connections for live trading data",
                        priority: "high",
                        impact: "Reduced latency and improved trading performance"
                    }
                ],
                analysis_quality: "demo_mode"
            };
            
            displayAIAnalysis(demoAnalysis);
            resultDiv.style.display = 'block';
            
            // Show a demo message
            setTimeout(() => {
                alert('üéØ Demo Mode: This shows how the AI analysis works! Click "üìÑ Generate MDC File" to create a sample integration file.');
            }, 500);
        }
        
        function displayAIAnalysis(analysis) {
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            const connectionRecs = analysis.connection_recommendations || [];
            const serviceImprovements = analysis.service_improvements || [];
            const archRecs = analysis.architectural_recommendations || [];
            
            resultDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="color: #4fd1c7; font-size: 1.2rem; font-weight: bold;">
                        ü§ñ AI Analysis Complete (${analysis.analysis_quality === 'ai_powered' ? 'ChatGPT-4' : 'Fallback'})
                    </span>
                    <br>
                    <span style="color: #a0a0a0; font-size: 0.9rem;">
                        ${connectionRecs.length} connection recommendations ‚Ä¢ ${serviceImprovements.length} service improvements
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: rgba(79, 209, 199, 0.1); padding: 20px; border-radius: 12px; border: 2px solid rgba(79, 209, 199, 0.3);">
                        <h4 style="color: #4fd1c7; margin-bottom: 20px; text-align: center; font-size: 1.3rem;">üîó Top Connection Opportunities</h4>
                        
                        <div style="display: grid; gap: 15px;">
                            ${connectionRecs.slice(0, 3).map((rec, index) => `
                                <div onclick="showConnectionsAndSelect(${index})" 
                                     style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(79, 209, 199, 0.3); 
                                            cursor: pointer; transition: all 0.3s ease; text-align: center;"
                                     onmouseover="this.style.borderColor='#4fd1c7'; this.style.boxShadow='0 2px 10px rgba(79, 209, 199, 0.3)'"
                                     onmouseout="this.style.borderColor='rgba(79, 209, 199, 0.3)'; this.style.boxShadow='none'">
                                    
                                    <div style="color: #4fd1c7; font-size: 1.5rem; margin-bottom: 8px;">üîó</div>
                                    <strong style="color: #fff; font-size: 1rem; display: block; margin-bottom: 8px;">
                                        ${rec.service_a} ‚Üî ${rec.service_b}
                                    </strong>
                                    
                                    <span style="background: ${rec.priority === 'high' ? '#48bb78' : rec.priority === 'medium' ? '#ed8936' : '#718096'}; 
                                               color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">
                                        ${rec.priority} Priority
                                    </span>
                                    
                                    <div style="color: #a0a0a0; font-size: 0.8rem; margin-top: 8px; font-style: italic;">
                                        Click to view details
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(79, 209, 199, 0.2);">
                            <button onclick="showConnections()" 
                                    style="background: linear-gradient(135deg, #4fd1c7, #38b2ac); color: #000; border: none; 
                                           padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                                üîç View All Recommendations
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(237, 137, 54, 0.1); padding: 20px; border-radius: 12px; border: 2px solid rgba(237, 137, 54, 0.3);">
                        <h4 style="color: #ed8936; margin-bottom: 20px; text-align: center; font-size: 1.3rem;">‚ö° Implementation Improvements</h4>
                        
                        <div style="display: grid; gap: 15px;">
                            ${serviceImprovements.slice(0, 3).map(imp => `
                                <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(237, 137, 54, 0.3); text-align: center;">
                                    <div style="color: #ed8936; font-size: 1.5rem; margin-bottom: 8px;">‚ö°</div>
                                    <strong style="color: #fff; font-size: 1rem; display: block; margin-bottom: 8px;">${imp.service}</strong>
                                    <p style="color: #a0a0a0; font-size: 0.9rem; margin: 8px 0; line-height: 1.4;">${imp.improvement}</p>
                                    <span style="background: ${imp.priority === 'high' ? '#48bb78' : imp.priority === 'medium' ? '#ed8936' : '#718096'}; 
                                               color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">
                                        ${imp.priority} Impact
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(237, 137, 54, 0.2);">
                            <button onclick="showImprovements()" 
                                    style="background: linear-gradient(135deg, #ed8936, #f6ad55); color: #000; border: none; 
                                           padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                                üîß View All Improvements
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="showConnections()" style="margin-right: 10px;">
                        View All ${connectionRecs.length} Recommendations
                    </button>
                    <button class="btn btn-secondary" onclick="showImprovements()">
                        View All ${serviceImprovements.length} Improvements
                    </button>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }
        
        async function showConnections() {
            try {
                const response = await fetch('/api/discovery/recommendations');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayConnectionRecommendations(data.connection_recommendations);
                
            } catch (error) {
                console.error('‚ùå Failed to load connection recommendations:', error);
                showError(`Failed to load recommendations: ${error.message}`);
            }
        }
        
        async function showImprovements() {
            try {
                const response = await fetch('/api/discovery/improvements');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayServiceImprovements(data.service_improvements, data.architectural_recommendations);
                
            } catch (error) {
                console.error('‚ùå Failed to load service improvements:', error);
                showError(`Failed to load improvements: ${error.message}`);
            }
        }
        
        function displayConnectionRecommendations(recommendations) {
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            // Store recommendations globally for the preview card
            window.currentRecommendations = recommendations;
            
            resultDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #4fd1c7;">üîó Intelligent Connection Recommendations</h3>
                    <p style="color: #a0a0a0;">ChatGPT-4 analyzed your services and suggests these connections</p>
                    <p style="color: #ed8936; font-size: 0.9rem; margin-top: 10px;">Click on any card below to view integration details</p>
                </div>
                
                <!-- Top 3 Cards Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    ${recommendations.map((rec, index) => `
                        <div onclick="showRecommendationPreview(${index})" 
                             style="background: rgba(79, 209, 199, 0.1); border: 2px solid rgba(79, 209, 199, 0.3); 
                                    border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease;
                                    hover:border-color: #4fd1c7; hover:box-shadow: 0 4px 20px rgba(79, 209, 199, 0.2);"
                             onmouseover="this.style.borderColor='#4fd1c7'; this.style.boxShadow='0 4px 20px rgba(79, 209, 199, 0.2)'"
                             onmouseout="this.style.borderColor='rgba(79, 209, 199, 0.3)'; this.style.boxShadow='none'">
                            
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div style="color: #4fd1c7; font-size: 2rem; margin-bottom: 10px;">üîó</div>
                                <h4 style="color: #fff; margin: 0; font-size: 1.1rem; line-height: 1.3;">
                                    ${rec.service_a}<br>‚Üî<br>${rec.service_b}
                                </h4>
                            </div>
                            
                            <div style="text-align: center;">
                                <span style="background: ${rec.priority === 'high' ? '#48bb78' : rec.priority === 'medium' ? '#ed8936' : '#718096'}; 
                                             color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">
                                    ${rec.priority} Priority
                                </span>
                            </div>
                            
                            <div style="margin-top: 15px; text-align: center; color: #a0a0a0; font-size: 0.9rem;">
                                ${rec.connection_type.replace('_', ' ')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Landscape Preview Card -->
                <div id="recommendation-preview" style="display: none; background: linear-gradient(135deg, #1e2832 0%, #1a2332 100%); 
                                                         border: 2px solid #4fd1c7; border-radius: 12px; padding: 30px; margin-top: 20px;">
                    <div id="preview-content">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="runAIAnalysis()">üîÑ Refresh Analysis</button>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }
        
        function displayServiceImprovements(improvements, archRecs) {
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            resultDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #ed8936;">‚ö° Service Implementation Improvements</h3>
                    <p style="color: #a0a0a0;">ChatGPT-4 suggestions to enhance your services</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #4fd1c7; margin-bottom: 15px;">üõ†Ô∏è Service-Specific Improvements</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        ${improvements.map(imp => `
                            <div style="background: rgba(237, 137, 54, 0.1); border: 1px solid rgba(237, 137, 54, 0.3); 
                                        border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: #ed8936; font-size: 1.1rem;">${imp.service}</strong>
                                    <span style="background: ${imp.priority === 'high' ? '#48bb78' : imp.priority === 'medium' ? '#ed8936' : '#718096'}; 
                                                 color: #fff; padding: 3px 6px; border-radius: 3px; font-size: 0.8rem;">
                                        ${imp.priority}
                                    </span>
                                </div>
                                <p style="color: #e0e0e0; margin-bottom: 10px; font-size: 0.9rem;">${imp.improvement}</p>
                                <div style="color: #a0a0a0; font-size: 0.8rem;">
                                    <strong>Impact:</strong> ${imp.impact}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #4fd1c7; margin-bottom: 15px;">üèóÔ∏è Architectural Recommendations</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                        ${archRecs.map(rec => `
                            <div style="background: rgba(79, 209, 199, 0.1); border: 1px solid rgba(79, 209, 199, 0.3); 
                                        border-radius: 8px; padding: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4fd1c7; font-size: 1.1rem; text-transform: capitalize;">
                                        ${rec.area}
                                    </strong>
                                </div>
                                <p style="color: #e0e0e0; margin-bottom: 10px; font-size: 0.9rem;">${rec.recommendation}</p>
                                <div style="color: #a0a0a0; font-size: 0.8rem;">
                                    <strong>Affects:</strong> ${rec.services_affected.join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="runAIAnalysis()">üîÑ Refresh Analysis</button>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }

        // Database tracking functions
        async function loadDatabaseStats() {
            try {
                // Load analyzed pairs stats
                const pairsResponse = await fetch('/api/analyzer-pairs');
                const pairsData = await pairsResponse.json();
                
                // Load winners stats
                const winnersResponse = await fetch('/api/analyzer-winners');
                const winnersData = await winnersResponse.json();
                
                // Update analyzed pairs stats
                if (pairsData.status === 'success') {
                    document.getElementById('totalAnalyzedPairs').textContent = pairsData.total_count;
                    const averageScore = pairsData.pairs.length > 0 ? 
                        (pairsData.pairs.reduce((sum, pair) => sum + pair.compatibility_score, 0) / pairsData.pairs.length).toFixed(2) : 0;
                    document.getElementById('averageScore').textContent = averageScore;
                } else {
                    document.getElementById('totalAnalyzedPairs').textContent = '0';
                    document.getElementById('averageScore').textContent = '0';
                }
                
                // Update winners stats
                if (winnersData.status === 'success') {
                    document.getElementById('totalWinnersCount').textContent = winnersData.total_count;
                    const highestScore = winnersData.winners.length > 0 ? 
                        Math.max(...winnersData.winners.map(w => w.compatibility_score)).toFixed(2) : 0;
                    document.getElementById('highestScore').textContent = highestScore;
                } else {
                    document.getElementById('totalWinnersCount').textContent = '0';
                    document.getElementById('highestScore').textContent = '0';
                }
                
            } catch (error) {
                console.error('Error loading database stats:', error);
                document.getElementById('totalAnalyzedPairs').textContent = 'Error';
                document.getElementById('averageScore').textContent = 'Error';
                document.getElementById('totalWinnersCount').textContent = 'Error';
                document.getElementById('highestScore').textContent = 'Error';
            }
        }

        async function showAnalyzedPairs() {
            try {
                const response = await fetch('/api/analyzer-pairs');
                const data = await response.json();
                
                if (data.status !== 'success') {
                    alert('Error loading analyzed pairs: ' + (data.message || 'Unknown error'));
                    return;
                }
                
                // Create modal display
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.8); z-index: 1000; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: #1a2332; border: 1px solid #2d3748; border-radius: 12px; 
                                max-width: 90vw; max-height: 80vh; overflow-y: auto; padding: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #4fd1c7; margin: 0;">üî¨ All Analyzed Pairs & ChatGPT Results</h3>
                            <button onclick="this.closest('div').parentElement.remove()" 
                                    style="background: #dc3545; color: white; border: none; border-radius: 5px; 
                                           padding: 5px 10px; cursor: pointer;">‚úï Close</button>
                        </div>
                        <div style="display: grid; gap: 15px;">
                            ${data.pairs.map(pair => `
                                <div style="background: rgba(45, 55, 72, 0.4); border-radius: 8px; padding: 15px; 
                                           border-left: 4px solid ${pair.is_winner ? '#28a745' : '#4fd1c7'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 style="color: #4fd1c7; margin: 0;">${pair.service_a} + ${pair.service_b}</h4>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            ${pair.is_winner ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">üèÜ WINNER</span>' : ''}
                                            <span style="color: #4fd1c7; font-weight: bold;">Score: ${pair.compatibility_score}</span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #a0a0a0;">Type:</strong> 
                                        <span style="color: #e0e0e0;">${pair.combination_type}</span>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #a0a0a0;">ChatGPT Analysis:</strong>
                                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; 
                                                    color: #e0e0e0; font-size: 0.9rem; line-height: 1.4;">
                                            ${pair.chatgpt_analysis}
                                        </div>
                                    </div>
                                    <div style="color: #a0a0a0; font-size: 0.8rem;">
                                        <strong>Analyzed:</strong> ${new Date(pair.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error showing analyzed pairs:', error);
                alert('Error loading analyzed pairs: ' + error.message);
            }
        }

        async function showWinners() {
            try {
                const response = await fetch('/api/analyzer-winners');
                const data = await response.json();
                
                if (data.status !== 'success') {
                    alert('Error loading winners: ' + (data.message || 'Unknown error'));
                    return;
                }
                
                // Create modal display
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.8); z-index: 1000; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: #1a2332; border: 1px solid #28a745; border-radius: 12px; 
                                max-width: 90vw; max-height: 80vh; overflow-y: auto; padding: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #28a745; margin: 0;">üèÜ Winners Database & Random Selection</h3>
                            <button onclick="this.closest('div').parentElement.remove()" 
                                    style="background: #dc3545; color: white; border: none; border-radius: 5px; 
                                           padding: 5px 10px; cursor: pointer;">‚úï Close</button>
                        </div>
                        <div style="display: grid; gap: 15px;">
                            ${data.winners.map((winner, index) => `
                                <div style="background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; 
                                           border-radius: 8px; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 style="color: #28a745; margin: 0;">ü•á ${winner.service_a} + ${winner.service_b}</h4>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">#${index + 1}</span>
                                            <span style="color: #28a745; font-weight: bold;">Score: ${winner.compatibility_score}</span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #a0a0a0;">Type:</strong> 
                                        <span style="color: #e0e0e0;">${winner.combination_type}</span>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #a0a0a0;">ChatGPT Analysis:</strong>
                                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 5px; 
                                                    color: #e0e0e0; font-size: 0.9rem; line-height: 1.4;">
                                            ${winner.chatgpt_analysis}
                                        </div>
                                    </div>
                                    <div style="color: #a0a0a0; font-size: 0.8rem;">
                                        <strong>Won at:</strong> ${new Date(winner.winner_selected_at).toLocaleString()} | 
                                        <strong>Analyzed:</strong> ${new Date(winner.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${data.winners.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: #a0a0a0;">No winners yet - wait for the 4-hour cycle to complete</div>' : 
                            ''}
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error showing winners:', error);
                alert('Error loading winners: ' + error.message);
            }
        }

        async function addAnotherRecommendation() {
            try {
                const response = await fetch('/api/add-recommendation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert(`Found ${data.recommendations.length} additional recommendations from database!\\n\\nTop recommendations:\\n${data.recommendations.map((rec, i) => `${i+1}. ${rec.service_a} + ${rec.service_b} (Score: ${rec.compatibility_score})`).join('\\n')}`);
                    
                    // Refresh the analysis display to show new recommendations
                    runAIAnalysis();
                } else if (data.status === 'info') {
                    alert(data.message);
                } else {
                    alert('Error adding recommendation: ' + (data.message || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error adding recommendation:', error);
                alert('Error adding recommendation: ' + error.message);
            }
        }

        // Load database stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseStats();
            // Refresh database stats every 30 seconds
            setInterval(loadDatabaseStats, 30000);
        });
    </script>
</body>
</html>