<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZmartBot Database Management Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
            line-height: 1.6;
        }

        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
        }

        /* Sidebar - Dark Mode */
        .sidebar {
            background: linear-gradient(180deg, #111111 0%, #1a1a1a 100%);
            border-right: 1px solid #333333;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        }

        .sidebar-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333333;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border-radius: 12px;
            padding: 25px 15px;
        }

        .sidebar-header h1 {
            font-size: 1.4em;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .sidebar-header .subtitle {
            font-size: 0.85em;
            color: #888888;
            font-weight: 500;
        }

        .category-section {
            margin-bottom: 15px;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border: 1px solid #333333;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 8px;
        }

        .category-header:hover {
            background: linear-gradient(135deg, #2a2a2a, #333333);
            border-color: #00d4ff;
            transform: translateX(4px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
        }

        .category-header.active {
            background: linear-gradient(135deg, #00d4ff, #5b73ff);
            border-color: #00d4ff;
            box-shadow: 0 12px 30px rgba(0, 212, 255, 0.3);
            color: #000000;
        }

        .category-header.active .category-count {
            background: rgba(0, 0, 0, 0.2);
            color: #000000;
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .category-icon {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }

        .category-count {
            background: linear-gradient(45deg, #333333, #444444);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            color: #ffffff;
            min-width: 35px;
            text-align: center;
        }

        .database-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-left: 15px;
        }

        .database-list.open {
            max-height: 400px;
            margin-bottom: 10px;
        }

        .database-item {
            padding: 12px 16px;
            margin: 6px 0;
            background: linear-gradient(135deg, #1a1a1a, #222222);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }

        .database-item:hover {
            background: linear-gradient(135deg, #222222, #2a2a2a);
            border-color: #00d4ff;
            border-left-color: #00d4ff;
            transform: translateX(4px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.1);
        }

        .database-item.selected {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(91, 115, 255, 0.1));
            border-color: #00d4ff;
            border-left-color: #00d4ff;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.2);
        }

        .database-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: #ffffff;
            font-size: 0.9em;
        }

        .database-stats {
            display: flex;
            gap: 12px;
            font-size: 0.75em;
            color: #aaaaaa;
        }

        .database-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Main Content - Dark Mode */
        .main-content {
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 25px 30px;
            background: linear-gradient(135deg, #1a1a1a, #222222);
            border: 1px solid #333333;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .system-stats {
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 800;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85em;
            color: #aaaaaa;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 24px 14px 50px;
            background: linear-gradient(135deg, #222222, #2a2a2a);
            border: 1px solid #444444;
            border-radius: 30px;
            color: #ffffff;
            font-size: 1em;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }

        .search-input:focus {
            background: linear-gradient(135deg, #2a2a2a, #333333);
            border-color: #00d4ff;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
        }

        .search-input::placeholder {
            color: #666666;
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #888888;
            font-size: 1.1em;
        }

        /* Central Database Card - Dark Mode */
        .database-detail {
            flex: 1;
            background: linear-gradient(135deg, #1a1a1a, #222222);
            border: 1px solid #333333;
            border-radius: 20px;
            padding: 35px;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }

        .welcome-icon {
            font-size: 4.5em;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-title {
            font-size: 2.8em;
            font-weight: 300;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ffffff, #cccccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 1.3em;
            color: #888888;
            max-width: 650px;
            line-height: 1.6;
        }

        .database-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid #333333;
        }

        .database-title {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .database-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: #000000;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .database-info h2 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
            color: #ffffff;
        }

        .database-category {
            background: linear-gradient(45deg, #333333, #444444);
            color: #00d4ff;
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .health-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.1em;
        }

        .health-excellent {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000000;
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3);
        }

        .health-good {
            background: linear-gradient(45deg, #ffb347, #ff8c00);
            color: #000000;
            box-shadow: 0 6px 20px rgba(255, 140, 0, 0.3);
        }

        .health-warning {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .metric-card {
            background: linear-gradient(135deg, #222222, #2a2a2a);
            border: 1px solid #333333;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-8px);
            background: linear-gradient(135deg, #2a2a2a, #333333);
            border-color: #00d4ff;
            box-shadow: 0 12px 35px rgba(0, 212, 255, 0.15);
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-value {
            font-size: 2.8em;
            font-weight: 800;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .metric-label {
            color: #cccccc;
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tools-section {
            margin-top: 35px;
        }

        .tools-header {
            font-size: 1.6em;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            color: #ffffff;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
        }

        .tool-button {
            background: linear-gradient(135deg, #222222, #2a2a2a);
            border: 1px solid #333333;
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #ffffff;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .tool-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(0, 212, 255, 0.1), rgba(91, 115, 255, 0.1));
            transition: left 0.3s ease;
        }

        .tool-button:hover {
            background: linear-gradient(135deg, #2a2a2a, #333333);
            border-color: #00d4ff;
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0, 212, 255, 0.2);
        }

        .tool-button:hover::before {
            left: 0;
        }

        .tool-icon {
            font-size: 1.8em;
            margin-bottom: 12px;
            display: block;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        .tool-button span {
            position: relative;
            z-index: 1;
            font-weight: 600;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.3em;
            color: #aaaaaa;
        }

        .spinner {
            border: 4px solid #333333;
            border-radius: 50%;
            border-top: 4px solid #00d4ff;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
            margin-right: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Service Lifecycle Indicators */
        .service-lifecycle-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lifecycle-discovered {
            background: linear-gradient(45deg, #ffa726, #ffb74d);
            color: #000000;
        }

        .lifecycle-passport {
            background: linear-gradient(45deg, #42a5f5, #64b5f6);
            color: #000000;
        }

        .lifecycle-registry {
            background: linear-gradient(45deg, #66bb6a, #81c784);
            color: #000000;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 280px 1fr;
            }
            
            .system-stats {
                gap: 20px;
            }
            
            .search-bar {
                margin: 0 15px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                height: auto;
                max-height: 300px;
                padding: 15px;
            }

            .system-stats {
                flex-direction: column;
                gap: 15px;
            }

            .search-bar {
                margin: 15px 0;
                max-width: 100%;
            }

            .tools-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #333333, #444444);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #444444, #555555);
        }

        /* Service-specific styles */
        .service-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #222222, #2a2a2a);
            border: 1px solid #333333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .service-item:hover {
            background: linear-gradient(135deg, #2a2a2a, #333333);
            border-color: #00d4ff;
            transform: translateY(-1px);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .service-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #ffffff;
            display: flex;
            align-items: center;
        }

        .service-port {
            font-size: 0.75rem;
            font-family: monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .service-type {
            font-size: 0.75rem;
            color: #aaaaaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .service-status {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .discovered-placeholder {
            text-align: center;
            padding: 20px;
            color: #888888;
            font-style: italic;
        }

        .service-detail-view {
            padding: 0;
        }

        .service-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333333;
        }

        .service-detail-header h2 {
            color: #ffffff;
            font-size: 1.8rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #000000;
        }

        .service-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .detail-card {
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 20px;
        }

        .detail-card.full-width {
            grid-column: 1 / -1;
        }

        .detail-card h3 {
            color: #00d4ff;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #333333;
        }

        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .passport-id {
            font-family: monospace;
            background: linear-gradient(135deg, #1a1a1a, #222222);
            padding: 10px;
            border-radius: 6px;
            color: #00d4ff;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .metadata-display {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            color: #cccccc;
            font-size: 0.8rem;
            overflow-x: auto;
            border: 1px solid #333333;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar with Categories -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-database"></i> Database Center</h1>
                <div class="subtitle">Professional Management</div>
            </div>
            
            <div id="categories-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading categories...
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="system-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-databases">--</div>
                        <div class="stat-label">Total Databases</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="active-databases">--</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-records">--</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                </div>
                
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search databases..." id="search-input">
                </div>
                
                <div class="stat-item">
                    <div class="stat-value" id="avg-health">--</div>
                    <div class="stat-label">Avg Health</div>
                </div>
            </div>

            <!-- Database Detail Card -->
            <div class="database-detail" id="database-detail">
                <div class="welcome-screen">
                    <i class="fas fa-chart-line welcome-icon"></i>
                    <div class="welcome-title">ZmartBot Database Management</div>
                    <div class="welcome-subtitle">
                        Select a database from the categories on the left to view detailed information, metrics, and management tools.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allDatabases = [];
        let allServices = [];
        let selectedDatabase = null;
        let categories = {};
        let serviceCategories = {};
        let currentView = 'databases'; // 'databases' or 'services'

        // Enhanced category icons mapping
        const categoryIcons = {
            'ai_learning': 'fas fa-brain',
            'trading_data': 'fas fa-chart-candlestick',
            'risk_analysis': 'fas fa-shield-alt',
            'testing': 'fas fa-vial',
            'service_lifecycle': 'fas fa-cogs',
            'infrastructure': 'fas fa-server',
            'analysis': 'fas fa-analytics',
            'unknown': 'fas fa-question-circle'
        };

        // Service category icons mapping
        const serviceCategoryIcons = {
            'registered': 'fas fa-certificate',
            'active': 'fas fa-passport',
            'discovered': 'fas fa-search',
            'all': 'fas fa-server',
            'backend': 'fas fa-server',
            'protection': 'fas fa-shield-alt',
            'srv': 'fas fa-cog',
            'agt': 'fas fa-robot',
            'eng': 'fas fa-tools',
            'db': 'fas fa-database'
        };

        // Service Lifecycle specific indicators
        const serviceLifecycleTypes = {
            'service_registry.db': { type: 'registry', label: 'Registry', icon: 'fas fa-bookmark' },
            'passport_registry.db': { type: 'passport', label: 'Passport', icon: 'fas fa-id-card' },
            'discovery_registry.db': { type: 'discovered', label: 'Discovered', icon: 'fas fa-search-plus' }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDatabases();
            await loadServices();
            setupSearch();
            addViewToggle();
            
            // Auto-refresh every 30 seconds
            setInterval(async () => {
                await loadDatabases();
                await loadServices();
            }, 30000);
        });

        // Add view toggle between databases and services
        function addViewToggle() {
            const header = document.querySelector('.sidebar-header');
            const toggleHtml = `
                <div class="view-toggle" style="margin-top: 15px;">
                    <button class="toggle-btn active" onclick="showDatabases()" id="db-toggle">
                        <i class="fas fa-database"></i> Databases
                    </button>
                    <button class="toggle-btn" onclick="showServices()" id="svc-toggle">
                        <i class="fas fa-server"></i> Services
                    </button>
                </div>
            `;
            header.insertAdjacentHTML('afterend', toggleHtml);
            
            // Add CSS for toggle buttons
            const style = document.createElement('style');
            style.textContent = `
                .view-toggle {
                    display: flex;
                    gap: 5px;
                    margin: 15px 0;
                }
                .toggle-btn {
                    flex: 1;
                    padding: 8px 12px;
                    background: #2a2a2a;
                    border: 1px solid #444;
                    color: #aaa;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.8rem;
                    transition: all 0.3s ease;
                }
                .toggle-btn:hover {
                    background: #333;
                    color: #fff;
                }
                .toggle-btn.active {
                    background: linear-gradient(45deg, #00d4ff, #5b73ff);
                    color: #000;
                    border-color: #00d4ff;
                    font-weight: bold;
                }
            `;
            document.head.appendChild(style);
        }

        // Load services data
        // Map API status to correct ZmartBot terminology
        function mapStatusToCorrectTerminology(apiStatus) {
            const statusMapping = {
                'CERTIFIED': 'REGISTERED',  // Level 3 - Services with Certification
                'PENDING': 'ACTIVE',        // Level 2 - Services with Passport  
                'DISCOVERY': 'DISCOVERED'   // Level 1 - Services with nothing assigned
            };
            return statusMapping[apiStatus] || apiStatus;
        }

        async function loadServices() {
            try {
                const response = await fetch('/api/services/registry');
                const data = await response.json();
                
                // Map API status to correct terminology
                allServices = (data.services || []).map(service => ({
                    ...service,
                    certification_status: mapStatusToCorrectTerminology(service.certification_status)
                }));
                updateServiceStats();
                categorizeServices();
                
            } catch (error) {
                console.error('Error loading services:', error);
                allServices = [];
            }
        }

        // Update service statistics
        function updateServiceStats() {
            const registeredCount = allServices.filter(s => s.certification_status === 'REGISTERED').length;
            const activeCount = allServices.filter(s => s.certification_status === 'ACTIVE').length;
            const totalServices = allServices.length;
            
            if (currentView === 'services') {
                document.getElementById('total-databases').textContent = totalServices;
                document.getElementById('active-databases').textContent = registeredCount;
                document.getElementById('total-records').textContent = activeCount;
                
                // Update labels
                document.querySelector('#total-databases').nextElementSibling.textContent = 'Total Services';
                document.querySelector('#active-databases').nextElementSibling.textContent = 'Registered';
                document.querySelector('#total-records').nextElementSibling.textContent = 'Active';
            }
        }

        // Categorize services
        function categorizeServices() {
            serviceCategories = {
                'registered': allServices.filter(s => s.certification_status === 'REGISTERED'),
                'active': allServices.filter(s => s.certification_status === 'ACTIVE'),
                'discovered': [], // Placeholder for discovered services
                'all': allServices
            };
        }

        async function loadDatabases() {
            try {
                const response = await fetch('/api/databases');
                const data = await response.json();
                
                allDatabases = data.databases || [];
                updateSystemStats();
                categorizeAndRender();
            } catch (error) {
                console.error('Failed to load databases:', error);
                showError('Failed to load databases. Please check the connection.');
            }
        }

        function updateSystemStats() {
            const totalDatabases = allDatabases.length;
            const activeDatabases = allDatabases.filter(db => db.status === 'ACTIVE').length;
            const totalRecords = allDatabases.reduce((sum, db) => sum + (db.record_count || 0), 0);
            const avgHealth = totalDatabases > 0 ? 
                Math.round(allDatabases.reduce((sum, db) => sum + (db.health_score || 0), 0) / totalDatabases) : 0;

            document.getElementById('total-databases').textContent = totalDatabases;
            document.getElementById('active-databases').textContent = activeDatabases;
            document.getElementById('total-records').textContent = formatNumber(totalRecords);
            document.getElementById('avg-health').textContent = avgHealth + '%';
        }

        // Show databases view
        function showDatabases() {
            currentView = 'databases';
            document.getElementById('db-toggle').classList.add('active');
            document.getElementById('svc-toggle').classList.remove('active');
            
            updateSystemStats();
            categorizeAndRender();
        }

        // Show services view
        function showServices() {
            currentView = 'services';
            document.getElementById('svc-toggle').classList.add('active');
            document.getElementById('db-toggle').classList.remove('active');
            
            updateServiceStats();
            renderServiceCategories();
        }

        function categorizeAndRender() {
            // Group databases by category
            categories = {};
            allDatabases.forEach(db => {
                const category = db.category || 'unknown';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(db);
            });

            renderCategories();
        }

        // Render service categories
        function renderServiceCategories() {
            const container = document.getElementById('categories-container');
            
            // Add discovered services count (placeholder)
            serviceCategories['discovered'] = Array(91).fill({
                service_name: 'Discovered Service',
                description: 'Service in discovered phase',
                certification_status: 'DISCOVERED'
            });

            const categoriesHtml = Object.entries(serviceCategories)
                .map(([category, services]) => {
                    const icon = serviceCategoryIcons[category] || serviceCategoryIcons['all'];
                    const displayName = category.charAt(0).toUpperCase() + category.slice(1);
                    
                    return `
                        <div class="category-section">
                            <div class="category-header" onclick="toggleServiceCategory('${category}')">
                                <div class="category-title">
                                    <i class="${icon} category-icon"></i>
                                    <span>${displayName} Services</span>
                                </div>
                                <div class="category-count">${services.length}</div>
                            </div>
                            <div class="database-list" id="service-category-${category}">
                                ${category === 'discovered' ? 
                                    `<div class="service-item discovered-placeholder">
                                        <i class="fas fa-search"></i>
                                        <span>91 Services in Discovery Phase</span>
                                    </div>` :
                                    services.map(service => createServiceCard(service)).join('')
                                }
                            </div>
                        </div>
                    `;
                }).join('');

            container.innerHTML = categoriesHtml;
        }

        // Create individual service card
        function createServiceCard(service) {
            const statusColor = service.certification_status === 'REGISTERED' ? '#00ff88' : 
                               service.certification_status === 'ACTIVE' ? '#ffaa00' : '#888';
            const statusIcon = service.certification_status === 'REGISTERED' ? 'fas fa-certificate' : 
                              service.certification_status === 'ACTIVE' ? 'fas fa-passport' : 'fas fa-search';
            
            return `
                <div class="service-item" onclick="showServiceDetails('${service.service_name}')" style="border-left: 3px solid ${statusColor};">
                    <div class="service-header">
                        <div class="service-name">
                            <i class="${statusIcon}" style="color: ${statusColor}; margin-right: 8px;"></i>
                            ${service.service_name}
                        </div>
                        <div class="service-port" style="color: ${statusColor};">
                            ${service.port ? `Port ${service.port}` : 'No Port'}
                        </div>
                    </div>
                    <div class="service-type">${service.service_type || 'Service'}</div>
                    <div class="service-status" style="color: ${statusColor};">
                        ${service.certification_status || 'UNKNOWN'}
                    </div>
                </div>
            `;
        }

        // Toggle service category
        function toggleServiceCategory(category) {
            const element = document.getElementById(`service-category-${category}`);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        // Show service details
        function showServiceDetails(serviceName) {
            const service = allServices.find(s => s.service_name === serviceName);
            if (!service) return;

            const detailHtml = `
                <div class="service-detail-view">
                    <div class="service-detail-header">
                        <h2><i class="fas fa-server"></i> ${service.service_name}</h2>
                        <div class="service-badge" style="background: ${service.certification_status === 'REGISTERED' ? '#00ff88' : service.certification_status === 'ACTIVE' ? '#ffaa00' : '#888'};">'
                            ${service.certification_status}
                        </div>
                    </div>
                    
                    <div class="service-detail-grid">
                        <div class="detail-card">
                            <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                            <div class="detail-row"><strong>Service Name:</strong> ${service.service_name}</div>
                            <div class="detail-row"><strong>Service Type:</strong> ${service.service_type || 'N/A'}</div>
                            <div class="detail-row"><strong>Port:</strong> ${service.port || 'No Port Assigned'}</div>
                            <div class="detail-row"><strong>Status:</strong> ${service.status || 'UNKNOWN'}</div>
                        </div>
                        
                        <div class="detail-card">
                            <h3><i class="fas fa-chart-line"></i> Health & Performance</h3>
                            <div class="detail-row"><strong>Health Score:</strong> ${service.health_score || 0}%</div>
                            <div class="detail-row"><strong>Category:</strong> ${service.category || 'general'}</div>
                            <div class="detail-row"><strong>Integration Level:</strong> Level ${service.integration_level || 1}</div>
                        </div>
                        
                        <div class="detail-card full-width">
                            <h3><i class="fas fa-file-alt"></i> Description</h3>
                            <p>${service.description || 'No description available'}</p>
                        </div>
                        
                        ${service.passport_id ? `
                            <div class="detail-card">
                                <h3><i class="fas fa-id-card"></i> Passport Information</h3>
                                <div class="passport-id">${service.passport_id}</div>
                                <div class="detail-row"><strong>Registered:</strong> ${new Date(service.registered_at || Date.now()).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                        
                        ${service.metadata && Object.keys(service.metadata).length > 0 ? `
                            <div class="detail-card full-width">
                                <h3><i class="fas fa-code"></i> Metadata</h3>
                                <pre class="metadata-display">${JSON.stringify(service.metadata, null, 2)}</pre>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('database-detail').innerHTML = detailHtml;
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            
            const categoriesHtml = Object.entries(categories)
                .sort(([,a], [,b]) => b.length - a.length)
                .map(([category, databases]) => {
                    const icon = categoryIcons[category] || categoryIcons['unknown'];
                    const displayName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    return `
                        <div class="category-section">
                            <div class="category-header" onclick="toggleCategory('${category}')">
                                <div class="category-title">
                                    <i class="${icon} category-icon"></i>
                                    <span>${displayName}</span>
                                </div>
                                <div class="category-count">${databases.length}</div>
                            </div>
                            <div class="database-list" id="category-${category}">
                                ${databases.map(db => {
                                    // Enhanced Service Lifecycle display
                                    let lifecycleIndicator = '';
                                    if (category === 'service_lifecycle' && serviceLifecycleTypes[db.name]) {
                                        const lifecycle = serviceLifecycleTypes[db.name];
                                        lifecycleIndicator = `<div class="service-lifecycle-indicator lifecycle-${lifecycle.type}">
                                            <i class="${lifecycle.icon}"></i> ${lifecycle.label}
                                        </div>`;
                                    }
                                    
                                    // Get display name for Service Lifecycle databases
                                    let displayName = db.name;
                                    if (category === 'service_lifecycle') {
                                        if (db.name === 'service_registry.db') {
                                            displayName = 'Certificate';
                                        } else if (db.name === 'passport_registry.db') {
                                            displayName = 'Passport (Level 2)';
                                        } else if (db.name === 'discovery_registry.db') {
                                            displayName = 'Discovery (Level 1)';
                                        }
                                    }
                                    
                                    return `
                                        <div class="database-item" onclick="selectDatabase('${db.name}')" data-db-name="${db.name}">
                                            <div class="database-name">${displayName}</div>
                                            ${lifecycleIndicator}
                                            <div class="database-stats">
                                                <span><i class="fas fa-table"></i> ${db.table_count || 0}</span>
                                                <span><i class="fas fa-database"></i> ${formatNumber(db.record_count || 0)}</span>
                                                <span><i class="fas fa-heart"></i> ${Math.round(db.health_score || 0)}%</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            
            container.innerHTML = categoriesHtml;
        }

        function toggleCategory(category) {
            const categoryList = document.getElementById(`category-${category}`);
            const header = categoryList.previousElementSibling;
            
            if (categoryList.classList.contains('open')) {
                categoryList.classList.remove('open');
                header.classList.remove('active');
            } else {
                // Close all other categories
                document.querySelectorAll('.database-list').forEach(list => {
                    list.classList.remove('open');
                    list.previousElementSibling.classList.remove('active');
                });
                
                // Open selected category
                categoryList.classList.add('open');
                header.classList.add('active');
            }
        }

        async function selectDatabase(dbName) {
            // Update selected state and restore original display names
            document.querySelectorAll('.database-item').forEach(item => {
                item.classList.remove('selected');
                // Restore original display name for all items
                const nameElement = item.querySelector('.database-name');
                if (nameElement && item.dataset.originalName) {
                    nameElement.textContent = item.dataset.originalName;
                }
            });
            document.querySelector(`[data-db-name="${dbName}"]`).classList.add('selected');

            // Update the display name to show exact database name when clicked
            const selectedItem = document.querySelector(`[data-db-name="${dbName}"]`);
            if (selectedItem) {
                const nameElement = selectedItem.querySelector('.database-name');
                if (nameElement) {
                    // Store original display name if not already stored
                    if (!selectedItem.dataset.originalName) {
                        selectedItem.dataset.originalName = nameElement.textContent;
                    }
                    // Show exact database name
                    nameElement.textContent = dbName;
                }
            }

            const database = allDatabases.find(db => db.name === dbName);
            if (!database) return;

            // Set the actual filename to show when clicked
            database.actualFileName = dbName;

            // Update category text dynamically based on database name
            let dynamicCategory = 'UNKNOWN';
            if (dbName === 'service_registry.db') {
                dynamicCategory = 'REGISTRY';
            } else if (dbName === 'passport_registry.db') {
                dynamicCategory = 'PASSPORT';
            } else if (dbName === 'discovery_registry.db') {
                dynamicCategory = 'DISCOVERY';
            }
            database.dynamicCategory = dynamicCategory;

            selectedDatabase = database;
            
            const detailContainer = document.getElementById('database-detail');
            detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading database details...</div>';

            try {
                // Fetch detailed database information
                const response = await fetch(`/api/databases/${encodeURIComponent(dbName)}`);
                const data = await response.json();
                
                // Merge the API data with our enhanced database object
                const enhancedData = { ...data.database, ...database };
                
                // Enhanced Service Lifecycle data fetching
                if (database.category === 'service_lifecycle') {
                    await fetchServiceLifecycleData(enhancedData);
                }
                
                renderDatabaseDetail(enhancedData);
            } catch (error) {
                console.error('Failed to load database details:', error);
                detailContainer.innerHTML = '<div class="error">Failed to load database details.</div>';
            }
        }

        async function fetchServiceLifecycleData(database) {
            try {
                // Fetch additional service lifecycle data
                if (database.name === 'service_registry.db') {
                    const response = await fetch('/api/services/registry');
                    if (response.ok) {
                        const lifecycleData = await response.json();
                        
                        // Store lifecycle data globally for dynamic service counting
                        globalLifecycleData = lifecycleData;
                        
                        database.additionalData = {
                            type: 'service_registry',
                            services: lifecycleData.services || [],
                            total_certified: lifecycleData.total || 0,
                            dynamic_validation: {
                                integrity_status: lifecycleData.integrity_status || 'UNKNOWN',
                                violations: lifecycleData.violations || {},
                                violation_count: lifecycleData.violations?.violation_count || 0
                            }
                        };
                    }
                }
                
                // Add more enhanced data fetching for other lifecycle databases
                if (database.name === 'passport_registry.db') {
                    database.additionalData = {
                        type: 'passport_registry',
                        description: 'System interaction tracking and passport management',
                        features: ['Port Assignment', 'Service Authentication', 'System Access Control']
                    };
                }
                
                if (database.name === 'discovery_registry.db') {
                    database.additionalData = {
                        type: 'discovery_registry',
                        description: 'Service discovery and initial registration tracking',
                        features: ['Service Discovery', 'Initial Tracking', 'Pre-Implementation Status']
                    };
                }
            } catch (error) {
                console.warn('Could not fetch additional service lifecycle data:', error);
            }
        }

        function renderDatabaseDetail(database) {
            const healthClass = getHealthClass(database.health_score);
            const healthLabel = getHealthLabel(database.health_score);
            
            // Enhanced Service Lifecycle section
            let additionalSection = '';
            if (database.category === 'service_lifecycle' && database.additionalData) {
                const data = database.additionalData;
                if (data.type === 'service_registry' && data.services) {
                    additionalSection = `
                        <div class="service-lifecycle-section" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #0a0a0a, #1a1a1a); border-radius: 15px; border: 1px solid #333;">
                            <h3 style="color: #00d4ff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-cogs"></i> Service Registry Details
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: #222; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #66bb6a;">${data.total_certified}</div>
                                    <div style="color: #aaa; font-size: 0.9em;">Certified Services</div>
                                </div>
                                <div style="background: #222; padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #42a5f5;">${data.services.length}</div>
                                    <div style="color: #aaa; font-size: 0.9em;">Total Entries</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (data.features) {
                    additionalSection = `
                        <div class="service-lifecycle-section" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #0a0a0a, #1a1a1a); border-radius: 15px; border: 1px solid #333;">
                            <h3 style="color: #00d4ff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="${serviceLifecycleTypes[database.name].icon}"></i> ${serviceLifecycleTypes[database.name].label} Features
                            </h3>
                            <p style="color: #ccc; margin-bottom: 20px;">${data.description}</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${data.features.map(feature => `
                                    <span style="background: linear-gradient(45deg, #333, #444); padding: 8px 15px; border-radius: 20px; color: #00d4ff; font-size: 0.9em;">
                                        ${feature}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            const html = `
                <div class="database-header">
                    <div class="database-title">
                        <div class="database-icon">
                            <i class="${categoryIcons[database.category] || categoryIcons['unknown']}"></i>
                        </div>
                        <div class="database-info">
                            <h2>${database.actualFileName || database.name}</h2>
                            <span class="database-category">${database.dynamicCategory || (database.category || 'unknown').replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="health-badge ${healthClass}">
                        <i class="fas fa-heart"></i>
                        ${Math.round(database.health_score || 0)}% ${healthLabel}
                    </div>
                </div>

                ${additionalSection}

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${getCorrectServiceCount(database)}</div>
                        <div class="metric-label">Services</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${formatNumber(database.record_count || 0)}</div>
                        <div class="metric-label">Last Joined</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${getLastServiceName(database)}</div>
                        <div class="metric-label">Name of the last service added into the (level ${getLevelFromDatabase(database)}) that was selected</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${database.integration_level || 0}</div>
                        <div class="metric-label">Last update</div>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="tools-header">
                        <i class="fas fa-tools"></i>
                        Database Management Tools
                    </div>
                    <div class="tools-grid">
                        <div class="tool-button" onclick="analyzeTables('${database.name}')">
                            <i class="fas fa-table tool-icon"></i>
                            <span>Analyze Tables</span>
                        </div>
                        <div class="tool-button" onclick="optimizeDatabase('${database.name}')">
                            <i class="fas fa-tachometer-alt tool-icon"></i>
                            <span>Optimize</span>
                        </div>
                        <div class="tool-button" onclick="backupDatabase('${database.name}')">
                            <i class="fas fa-download tool-icon"></i>
                            <span>Backup</span>
                        </div>
                        <div class="tool-button" onclick="viewSchema('${database.name}')">
                            <i class="fas fa-sitemap tool-icon"></i>
                            <span>Schema</span>
                        </div>
                        <div class="tool-button" onclick="runQuery('${database.name}')">
                            <i class="fas fa-terminal tool-icon"></i>
                            <span>Query Tool</span>
                        </div>
                        <div class="tool-button" onclick="exportData('${database.name}')">
                            <i class="fas fa-file-export tool-icon"></i>
                            <span>Export Data</span>
                        </div>
                        <div class="tool-button" onclick="viewLogs('${database.name}')">
                            <i class="fas fa-list tool-icon"></i>
                            <span>View Logs</span>
                        </div>
                        <div class="tool-button" onclick="repairDatabase('${database.name}')">
                            <i class="fas fa-wrench tool-icon"></i>
                            <span>Repair</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('database-detail').innerHTML = html;
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                // Filter databases
                const filteredDatabases = allDatabases.filter(db => 
                    db.name.toLowerCase().includes(searchTerm) ||
                    (db.category || '').toLowerCase().includes(searchTerm) ||
                    (db.description || '').toLowerCase().includes(searchTerm)
                );
                
                // Re-categorize filtered results
                const filteredCategories = {};
                filteredDatabases.forEach(db => {
                    const category = db.category || 'unknown';
                    if (!filteredCategories[category]) {
                        filteredCategories[category] = [];
                    }
                    filteredCategories[category].push(db);
                });
                
                // Render filtered categories
                categories = filteredCategories;
                renderCategories();
            });
        }

        // Tool functions
        function analyzeTables(dbName) {
            alert(` Analyzing tables for ${dbName}...`);
        }

        function optimizeDatabase(dbName) {
            alert(` Optimizing database ${dbName}...`);
        }

        function backupDatabase(dbName) {
            alert(` Creating backup for ${dbName}...`);
        }

        function viewSchema(dbName) {
            alert(` Viewing schema for ${dbName}...`);
        }

        function runQuery(dbName) {
            alert(` Opening query tool for ${dbName}...`);
        }

        function exportData(dbName) {
            alert(` Exporting data from ${dbName}...`);
        }

        function viewLogs(dbName) {
            alert(` Viewing logs for ${dbName}...`);
        }

        function repairDatabase(dbName) {
            alert(` Repairing database ${dbName}...`);
        }

        // Utility functions
        function getHealthClass(healthScore) {
            if (healthScore >= 90) return 'health-excellent';
            if (healthScore >= 70) return 'health-good';
            return 'health-warning';
        }

        function getHealthLabel(healthScore) {
            if (healthScore >= 90) return 'Excellent';
            if (healthScore >= 70) return 'Good';
            return 'Needs Attention';
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function showError(message) {
            document.getElementById('categories-container').innerHTML = `
                <div style="color: #ff6b6b; text-align: center; padding: 20px; background: linear-gradient(135deg, #1a1a1a, #222); border-radius: 12px; border: 1px solid #333;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px; color: #ff6b6b;"></i>
                    <br>${message}
                </div>
            `;
        }

        // Helper functions for dynamic service information
        function getLevelFromDatabase(database) {
            if (database.name === 'service_registry.db') return '3';
            if (database.name === 'passport_registry.db') return '2';
            if (database.name === 'discovery_registry.db') return '1';
            return 'X';
        }

        // Global variable to store dynamic lifecycle data
        let globalLifecycleData = null;

        function getCorrectServiceCount(database) {
            // Use dynamic lifecycle data if available
            if (globalLifecycleData) {
                if (database.name === 'service_registry.db') {
                    return globalLifecycleData.services?.certified || globalLifecycleData.level_3_certified || '0';
                }
                if (database.name === 'passport_registry.db') {
                    return globalLifecycleData.services?.passport || globalLifecycleData.level_2_passport || '0';
                }
                if (database.name === 'discovery_registry.db') {
                    return globalLifecycleData.services?.discovery || globalLifecycleData.level_1_discovery || '0';
                }
            }
            
            // Fallback to hardcoded values if dynamic data unavailable
            if (database.name === 'service_registry.db') return '21';  // Level 3: Certificate (FALLBACK)
            if (database.name === 'passport_registry.db') return '47';  // Level 2: Passport (FALLBACK)
            if (database.name === 'discovery_registry.db') return '5';  // Level 1: Discovery (FALLBACK)
            return database.table_count || 0; // Default for other databases
        }

        function getLastServiceName(database) {
            // This would typically fetch from the actual database
            // For now, return a placeholder based on the database type
            if (database.name === 'service_registry.db') return 'zmart-api';
            if (database.name === 'passport_registry.db') return 'passport-service';
            if (database.name === 'discovery_registry.db') return 'discovery-agent';
            return 'unknown-service';
        }
    </script>
</body>
</html>