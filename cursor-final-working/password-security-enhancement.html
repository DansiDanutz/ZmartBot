<!-- Password Security Enhancement for Onboarding -->
<!-- Add this to your index.html registration section -->

<script>
// Password Security Module
const PasswordSecurity = {
    // Common weak passwords to block
    commonPasswords: [
        'password', 'Password', 'password123', 'Password123', '12345678',
        'qwerty', 'abc123', '123456789', 'password1', 'iloveyou',
        'welcome', 'monkey', 'dragon', 'master', 'letmein'
    ],

    // Check password strength
    checkPasswordStrength(password) {
        const errors = [];
        const warnings = [];

        // Length check
        if (password.length < 8) {
            errors.push('Password must be at least 8 characters');
        }
        if (password.length < 12) {
            warnings.push('Consider using 12+ characters for better security');
        }

        // Complexity checks
        if (!/[a-z]/.test(password)) {
            errors.push('Include at least one lowercase letter');
        }
        if (!/[A-Z]/.test(password)) {
            errors.push('Include at least one uppercase letter');
        }
        if (!/[0-9]/.test(password)) {
            errors.push('Include at least one number');
        }
        if (!/[^a-zA-Z0-9]/.test(password)) {
            warnings.push('Consider adding special characters (!@#$%^&*)');
        }

        // Common password check
        if (this.commonPasswords.some(common =>
            password.toLowerCase().includes(common.toLowerCase())
        )) {
            errors.push('This password is too common and easily guessed');
        }

        // Sequential characters check
        if (/(.)\1{2,}/.test(password)) {
            errors.push('Avoid repeating characters (e.g., aaa, 111)');
        }
        if (/(?:abc|bcd|cde|def|123|234|345|456|567|678|789)/i.test(password)) {
            warnings.push('Avoid sequential patterns');
        }

        return {
            isValid: errors.length === 0,
            errors,
            warnings,
            strength: this.calculateStrength(password, errors.length, warnings.length)
        };
    },

    calculateStrength(password, errorCount, warningCount) {
        if (errorCount > 0) return 'weak';

        let score = 0;
        if (password.length >= 12) score++;
        if (password.length >= 16) score++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^a-zA-Z0-9]/.test(password)) score++;

        score -= warningCount * 0.5;

        if (score >= 4) return 'strong';
        if (score >= 2) return 'medium';
        return 'weak';
    },

    // Check against HaveIBeenPwned API (using k-anonymity)
    async checkBreached(password) {
        try {
            // Create SHA-1 hash of password
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-1', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();

            // Use k-anonymity: send only first 5 chars
            const prefix = hashHex.substring(0, 5);
            const suffix = hashHex.substring(5);

            // Check with HIBP API
            const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
            const text = await response.text();

            // Check if our suffix appears in the response
            const lines = text.split('\n');
            for (const line of lines) {
                const [hashSuffix, count] = line.split(':');
                if (hashSuffix === suffix) {
                    return {
                        breached: true,
                        count: parseInt(count)
                    };
                }
            }

            return { breached: false };
        } catch (error) {
            console.warn('Could not check password breach status:', error);
            return { breached: false, error: true };
        }
    },

    // Generate password strength UI
    getStrengthIndicator(strength) {
        const indicators = {
            weak: {
                color: '#ef4444',
                text: 'Weak',
                width: '33%'
            },
            medium: {
                color: '#f59e0b',
                text: 'Medium',
                width: '66%'
            },
            strong: {
                color: '#10b981',
                text: 'Strong',
                width: '100%'
            }
        };

        return indicators[strength] || indicators.weak;
    }
};

// Enhanced password validation function
async function validatePasswordSecurity(password) {
    const strengthCheck = PasswordSecurity.checkPasswordStrength(password);
    const breachCheck = await PasswordSecurity.checkBreached(password);

    // Build validation result
    const result = {
        isValid: strengthCheck.isValid && !breachCheck.breached,
        strength: strengthCheck.strength,
        errors: [...strengthCheck.errors],
        warnings: [...strengthCheck.warnings]
    };

    if (breachCheck.breached) {
        result.errors.unshift(`‚ö†Ô∏è This password has been found in ${breachCheck.count.toLocaleString()} data breaches!`);
        result.strength = 'weak';
    }

    return result;
}

// UI Integration Example
function setupPasswordField() {
    const passwordInput = document.getElementById('regPassword');
    const feedbackDiv = document.createElement('div');
    feedbackDiv.id = 'password-feedback';
    feedbackDiv.style.cssText = 'margin-top: 8px; font-size: 14px;';
    passwordInput.parentNode.appendChild(feedbackDiv);

    // Real-time validation
    let validationTimeout;
    passwordInput.addEventListener('input', (e) => {
        clearTimeout(validationTimeout);
        validationTimeout = setTimeout(async () => {
            const password = e.target.value;
            if (!password) {
                feedbackDiv.innerHTML = '';
                return;
            }

            feedbackDiv.innerHTML = '<span style="color: #6b7280;">Checking password security...</span>';

            const validation = await validatePasswordSecurity(password);
            const indicator = PasswordSecurity.getStrengthIndicator(validation.strength);

            let html = `
                <div style="margin-bottom: 8px;">
                    <div style="background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;">
                        <div style="background: ${indicator.color}; height: 100%; width: ${indicator.width}; transition: all 0.3s;"></div>
                    </div>
                    <span style="color: ${indicator.color}; font-weight: 500; font-size: 12px;">
                        Strength: ${indicator.text}
                    </span>
                </div>
            `;

            if (validation.errors.length > 0) {
                html += '<div style="color: #ef4444; margin-top: 4px;">';
                validation.errors.forEach(error => {
                    html += `<div>‚ùå ${error}</div>`;
                });
                html += '</div>';
            }

            if (validation.warnings.length > 0 && validation.errors.length === 0) {
                html += '<div style="color: #f59e0b; margin-top: 4px;">';
                validation.warnings.forEach(warning => {
                    html += `<div>üí° ${warning}</div>`;
                });
                html += '</div>';
            }

            feedbackDiv.innerHTML = html;
        }, 500);
    });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', setupPasswordField);
</script>

<!-- Add this CSS to your existing styles -->
<style>
#password-feedback {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}

.password-strength-bar {
    position: relative;
    margin-top: 8px;
}

.password-error {
    color: #ef4444;
    font-size: 13px;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.password-warning {
    color: #f59e0b;
    font-size: 13px;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.password-success {
    color: #10b981;
    font-size: 13px;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}
</style>